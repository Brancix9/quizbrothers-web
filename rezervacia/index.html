<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registr√°cia QuizBrothers</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="icon" href="../logo.png" type="image/png">
    <style>
        /* ≈†pecifick√© ≈°t√Ωly pre rezerv√°ciu */
        body { margin: 0; padding: 0; }
        
        /* Wrapper pre obsah (okrem headeru) */
        .content-wrapper { padding: 5px 20px; }
        
        /* LAYOUT */
        .main-container { display: flex; justify-content: center; align-items: flex-start; gap: 20px; max-width: 1200px; margin: 0 auto 30px auto; }
        .sidebar { flex: 1; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(34,36,84,0.1); min-height: 300px; }
        .form-container { flex: 1.5; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(34,36,84,0.15); text-align: center; border-top: 5px solid #222454; }
        
        .left-panel { border-top: 5px solid #222454; }
        .right-panel { border-top: 5px solid #27ae60; }
        .team-list { list-style: none; padding: 0; margin: 0; }
        .team-item { padding: 10px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 14px; }
        .badge-count { background: #eee; padding: 2px 8px; border-radius: 10px; font-size: 12px; color: #555; }
        .badge-confirmed { background: #d5f5e3; color: #27ae60; }

        h1 { color: #222454; margin-bottom: 2px; font-size: 1.8rem; }
        .quiz-date-info { font-size: 1.05em; font-weight: bold; color: #222454; margin-bottom: 2px; }
        .deadline-info { color: #e74c3c; font-weight: bold; font-size: 13px; margin-bottom: 12px; }
        
        .capacity-box { background: #f0f0f5; padding: 15px; border-radius: 10px; margin-bottom: 25px; border: 1px solid rgba(34,36,84,0.2); }
        .capacity-number { font-size: 2em; font-weight: bold; display: block; transition: color 0.3s; }
        .cap-safe { color: #27ae60; } .cap-warn { color: #e67e22; } .cap-crit { color: #c0392b; }
        
        label { display: block; text-align: left; margin: 15px 0 5px; font-weight: bold; color: #222454; }
        #pinSection { display: block !important; margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid #27ae60; }
        #pinSection label { margin: 0 0 1px 0; }
        #pinSection input { margin-bottom: 1px; }
        #pinSection small { margin-top: 0; }
        select, input { width: 100%; padding: 12px; border: 2px solid rgba(34,36,84,0.3); border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        select:focus, input:focus { outline: none; border-color: #222454; }
        
        button.btn-submit { width: 100%; background: #222454; color: white; border: none; padding: 15px; font-size: 18px; font-weight: bold; border-radius: 8px; margin-top: 25px; cursor: pointer; transition: 0.2s; }
        button.btn-submit:hover { background: #2d2f6a; }
        button.btn-decline { width: 100%; background: #e67e22; color: white; border: none; padding: 12px; font-size: 14px; font-weight: bold; border-radius: 8px; margin-top: 10px; cursor: pointer; transition: 0.2s; }
        button.btn-decline:hover { background: #d35400; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        /* ADMIN SEKCIA */
        #adminSection { display: none; border-top: 5px solid #222454; padding-top: 20px; margin-top: 50px; background: #f5f5f7; padding-bottom: 50px; }
        .admin-config { max-width: 95%; width: 95%; margin: 0 auto 30px auto; background: #222454; color: white; padding: 20px; border-radius: 10px; display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-between; align-items: center; }
        .config-block { display: flex; flex-direction: column; gap: 5px; }
        .config-block label { color: #aaa; font-size: 10px; margin: 0; text-transform: uppercase; }
        .btn-action { background: #27ae60; color: white; border: none; padding: 8px 15px; cursor: pointer; font-weight: bold; border-radius: 4px; }
        .btn-stop { background: #c0392b; color: white; border: none; padding: 8px 15px; cursor: pointer; font-weight: bold; border-radius: 4px; border: 1px solid #999; }
        
        .room-map { position: relative; max-width: 95%; width: 95%; height: 600px; background: #e0e0e0; border: 4px solid #444; margin: 20px auto; border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow-x: hidden; box-sizing: border-box; }
        .table { position: absolute; display: flex; justify-content: center; align-items: center; flex-direction: column; border: 2px solid #555; cursor: pointer; font-weight: bold; font-size: 11px; user-select: none; color: #333; text-align: center; line-height: 1; z-index: 10; background: #fff; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
        .status-reserved { background-color: #ffb347; border-color: #d35400; } .status-confirmed { background-color: #2ecc71; border-color: #27ae60; } .status-free { background-color: #fff; opacity: 0.7; }
        .cap-info { font-size: 9px; font-weight: normal; margin-top: 2px; }
        .rect { width: 110px; height: 55px; border-radius: 4px; } .circle { width: 75px; height: 75px; border-radius: 50%; } .circle-small { width: 55px; height: 55px; border-radius: 50%; }
        .admin-login-btn { 
            margin: 50px auto; 
            color: #999; 
            background: none; 
            border: none; 
            text-decoration: none; 
            cursor: pointer; 
            font-size: 11px;
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        
        #adminOldLoginBtn {
            display: none !important;
        }
        .admin-login-btn:hover {
            opacity: 0.6;
            color: #666;
        }

        .pin-manager { max-width: 95%; width: 95%; margin: 40px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(34,36,84,0.1); }
        .pin-manager h4 { margin-top: 0; }
        .pin-manager label { display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold; color: #222454; font-size: 13px; }
        .pin-table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: auto; }
        .pin-table th, .pin-table td { border: 1px solid rgba(34,36,84,0.2); padding: 12px; text-align: left; }
        .pin-table th { background-color: #f0f0f5; color: #222454; font-weight: bold; }
        .pin-table td { word-wrap: break-word; }
        .admin-input { padding: 8px; border: 1px solid rgba(34,36,84,0.3); border-radius: 4px; font-family: inherit; font-size: 14px; } 
        .admin-input:focus { outline: none; border-color: #222454; }
        textarea.admin-input { text-align: left; resize: vertical; }
        .w-small { width: 60px; } .w-med { width: 100px; }
        .btn-save-pin { background: #27ae60; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn-delete-team { background: #c0392b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 10px;}

        .add-team-form { background: #f9f9f9; padding: 15px; margin-top: 20px; border: 1px dashed rgba(34,36,84,0.3); border-radius: 5px; display: flex; gap: 10px; align-items: flex-end;}
        .form-group { flex: 1; } .form-group label { font-size: 11px; margin-bottom: 2px; color:#222454; }
        .btn-add { background: #222454; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; height: 42px; transition: 0.2s; }
        .btn-add:hover { background: #2d2f6a; }

        /* Table Assignment Modal */
        .table-assign-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9997; }
        .table-assign-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 15px; z-index: 9998; box-shadow: 0 10px 50px rgba(0,0,0,0.5); width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .table-assign-modal h3 { margin-top: 0; margin-bottom: 15px; color: #222454; font-size: 20px; text-align: center; }
        .table-assign-modal .team-option { padding: 12px; margin: 8px 0; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .table-assign-modal .team-option:hover { border-color: #222454; background: #f5f5f7; }
        .table-assign-modal .team-option.confirmed { border-color: #27ae60; background: #d5f5e3; }
        .table-assign-modal .team-option.reserved { border-color: #e67e22; background: #fff3e0; }
        .table-assign-modal .team-name { font-weight: bold; font-size: 14px; }
        .table-assign-modal .team-count { font-size: 12px; color: #666; }
        .table-assign-modal .btn-close { width: 100%; background: #ccc; color: #333; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .table-assign-modal .btn-clear { width: 100%; background: #e74c3c; color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .table-number { position: absolute; top: 2px; left: 2px; background: #222454; color: white; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; z-index: 11; }

        @media (max-width: 900px) {
            .content-wrapper { padding: 10px; }
            
            h1 { text-align: center; font-size: 1.5rem; }
            
            .main-container { 
                flex-direction: column; 
                max-width: 100%;
                margin: 20px auto;
                gap: 15px;
            } 
            .form-container { 
                order: 1; 
                width: 100%;
                max-width: 100%;
                padding: 20px;
            } 
            .right-panel { 
                order: 2; 
                width: 100%;
                max-width: 100%;
            } 
            .left-panel { 
                order: 3; 
                width: 100%;
                max-width: 100%;
            }
            .sidebar {
                width: 100%;
                max-width: 100%;
            }
            
            .add-team-form { flex-direction: column; } 
            .btn-add { width: 100%; }
            
            .admin-config { 
                flex-direction: column; 
                align-items: stretch; 
                text-align: center; 
                max-width: 98%; 
                width: 98%; 
                margin: 20px auto;
            }
            .pin-manager { 
                max-width: 98%; 
                width: 98%; 
                margin: 20px auto; 
                padding: 15px; 
            }
            .pin-table { 
                font-size: 14px; 
                width: 100%;
            }
            .pin-table th, .pin-table td { 
                padding: 8px; 
                font-size: 12px;
            }
            .room-map { 
                max-width: 98%; 
                width: 98%; 
                height: auto; 
                min-height: 400px; 
                margin: 20px auto;
            }
            
            #adminSection {
                padding: 20px 10px;
            }
        }
        
        @media (max-width: 768px) {
            .admin-login-btn {
                font-size: 10px;
                opacity: 0.25;
                margin: 30px auto;
            }
        }
        
        @media (max-width: 480px) {
            .content-wrapper { padding: 5px; }
            
            h1 { font-size: 1.2rem; margin-bottom: 5px; margin-top: 5px !important; }
            
            .admin-login-btn {
                font-size: 9px;
                opacity: 0.2;
                margin: 20px auto;
            }
            
            .main-container {
                margin: 5px auto;
                gap: 8px;
            }
            
            .form-container, .sidebar {
                padding: 12px;
            }
            
            .quiz-date-info {
                font-size: 0.95rem;
                margin-bottom: 3px;
            }
            
            .deadline-info {
                font-size: 11px;
                margin-bottom: 8px;
            }
            
            .capacity-box {
                padding: 10px;
                margin-bottom: 15px;
            }
            
            .capacity-number {
                font-size: 1.3em;
            }
            
            label {
                margin: 8px 0 4px;
                font-size: 14px;
            }
            
            select, input {
                padding: 10px;
                font-size: 15px;
            }
            
            #pinSection {
                margin-top: 10px;
                padding: 10px;
            }
            
            #pinSection label {
                font-size: 14px;
            }
            
            #pinSection small {
                font-size: 11px;
            }
            
            button.btn-submit {
                padding: 12px;
                font-size: 16px;
                margin-top: 15px;
            }
            
            .admin-config {
                padding: 15px;
            }
            
            .pin-manager {
                padding: 12px;
            }
            
            .pin-table {
                font-size: 11px;
            }
            
            .pin-table th, .pin-table td {
                padding: 6px;
                font-size: 11px;
            }
            
            .room-map {
                max-width: 100%;
                width: 100%;
                min-height: 300px;
                overflow-x: hidden;
                box-sizing: border-box;
            }
            
            .btn-save-pin, .btn-delete-team {
                margin: 5px 3px;
                display: inline-block;
            }
            
            .btn-delete-team {
                margin-left: 15px;
            }
        }
        
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 20px; color: #222454; font-weight: bold; }
    </style>
</head>
<body>

    <header>
        <div class="nav-container">
            <a href="../" class="logo">
                <img src="../logo.png" alt="QuizBrothers Logo">
                <span>Quiz<span>Brothers</span></span>
            </a>
            <div class="menu-toggle" onclick="document.getElementById('nav-list').classList.toggle('show')">‚ò∞</div>
            <nav>
                <ul id="nav-list">
                    <li><a href="../">Domov</a></li>
                    <li><a href="../rezervacia/" class="active">Rezerv√°cia stola</a></li>
                    <li><a href="../aplikacia/">Aplik√°cia</a></li>
                    <li><a href="/sienslavy/">Sie≈à sl√°vy</a></li>
                    <li><a href="../onas/">O n√°s</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div id="loadingOverlay">Naƒç√≠tavam syst√©m...</div>

    <div class="content-wrapper">
    <h1 style="text-align:center; margin-top:2px;">Registr√°cia QuizBrothers</h1>
    
    <div style="text-align:center;">
        <div id="publicQuizDate" class="quiz-date-info">Naƒç√≠tavam...</div>
        <div id="publicDeadlineInfo" class="deadline-info"></div>
    </div>

    <div class="main-container">
        <div class="sidebar left-panel">
            <h3 style="color:#222454;">‚è≥ Rezervovan√© (do <span id="reservedDeadlineDisplay">15:00</span>)</h3>
            <ul id="listReserved" class="team-list"></ul>
            
            <div id="adminLoginPrompt" style="display: none; text-align: center; margin-top: 20px; padding: 10px 15px; background: #f0f8ff; border-radius: 10px;">
                <p style="color: #222454; font-weight: bold; margin: 0 0 8px 0; font-size: 14px;">Ste administr√°tor?</p>
                <button onclick="window.qbAdmin.showLoginModal()" style="background: #222454; color: white; border: none; padding: 12px 20px; cursor: pointer; font-weight: bold; border-radius: 5px;">üîê Prihl√°si≈• sa ako Admin</button>
            </div>
        </div>

        <div class="form-container">
            <div class="capacity-box">
                <span>Zost√°va voƒæn√Ωch miest:</span>
                <span id="displayCapacity" class="capacity-number cap-safe">...</span>
                <small>Celkov√° kapacita: 83</small>
            </div>

            <form id="quizForm">
                <label>Vyber svoj t√≠m:</label>
                <select id="teamSelect" name="teamSelect" onchange="handleTeamChange()">
                    <option value="new">Nov√Ω t√≠m / Vybra≈• t√≠m</option>
                </select>
                <small id="teamReservedInfo" style="color:#222454; display:none; font-weight:bold; margin-top:5px;"></small>

                <div id="newTeamInput" style="display:block;">
                    <label>N√°zov nov√©ho t√≠mu:</label>
                    <input type="text" id="customTeamName" name="customTeamName" placeholder="Zadaj n√°zov t√≠mu" oninput="handleTeamChange()">
                </div>

                <label>Poƒçet hr√°ƒçov:</label>
                <input type="number" id="playerCount" name="playerCount" min="1" max="15" value="4">

                <div id="pinSection">
                    <label id="pinLabel" style="color:#27ae60;">Vytvor si PIN k√≥d:</label>
                    <input type="text" id="teamPin" name="teamPin" inputmode="numeric" pattern="[0-9]*" placeholder="Napr. 123">
                    <small id="pinHelp" style="color:#666; display:block; margin-top:5px;">Tento PIN bude≈° potrebova≈• pre zmeny.</small>
                </div>
                
                <button type="button" id="submitBtn" class="btn-submit">Potvrdi≈• √∫ƒças≈•</button>
                <button type="button" id="declineBtn" class="btn-decline" style="display: none;" onclick="window.declineTeamParticipation()">Nepr√≠deme</button>
                <button type="button" id="cancelBtn" class="btn-submit" style="background: #c0392b; display: none; margin-top: 10px;" onclick="window.cancelTeamParticipation()">üö´ Zru≈°i≈• √∫ƒças≈•</button>
            </form>
            <p id="formMessage" style="color: green; font-weight: bold; margin-top: 15px;"></p>
        </div>

        <div class="sidebar right-panel">
            <h3 style="color:#27ae60;">‚úÖ Potvrden√© t√≠my</h3>
            <ul id="listConfirmed" class="team-list"></ul>
            
            <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 10px;">
                <p style="color: #666; font-size: 13px; margin-bottom: 8px;">Potrebujete pom√¥c≈•?</p>
                <a href="https://facebook.com/quizbrothers" target="_blank" style="display: inline-flex; align-items: center; gap: 8px; text-decoration: none; color: #1877F2; font-weight: bold; font-size: 14px; padding: 8px 12px; background: white; border-radius: 6px; transition: 0.2s; border: 1px solid #1877F2;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="#1877F2">
                        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                    </svg>
                    <span>Nap√≠≈°te n√°m na Facebooku</span>
                </a>
            </div>
        </div>
    </div>

    <button class="admin-login-btn" id="adminOldLoginBtn" onclick="toggleAdmin()" style="display: none;">ADMIN LOGIN</button>

    <div id="adminSection">
        <div class="admin-config">
            <div><h3 style="margin:0; color:#27ae60;">üîß Admin Panel</h3></div>
            <div class="config-block">
                <label>D√°tum Kv√≠zu:</label>
                <div style="display:flex; gap:5px;">
                    <input type="date" id="adminQuizDate" style="padding:5px;">
                    <button class="btn-action" onclick="saveQuizDate()">Ulo≈æi≈•</button>
                </div>
            </div>
            <div class="config-block">
                <label>Status:</label>
                <button class="btn-stop" onclick="stopRegistration()">‚õî STOP / NEURƒåEN√â</button>
            </div>
            <div class="config-block">
                <label>Admin PIN:</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="newMasterPin" inputmode="numeric" pattern="[0-9]*" placeholder="Nov√Ω PIN" style="width:80px; padding:5px; text-align:center;">
                    <button class="btn-action" onclick="saveMasterPin()">Zmeni≈•</button>
                </div>
            </div>
            <div class="config-block">
                <label>Deadline (ƒças):</label>
                <div style="display:flex; gap:5px;">
                    <input type="time" id="adminDeadlineTime" style="padding:5px;">
                    <button class="btn-action" onclick="saveDeadlineTime()">Ulo≈æi≈•</button>
                </div>
            </div>
            <div class="config-block">
                <label>Uvoƒænenie (ƒças):</label>
                <div style="display:flex; gap:5px;">
                    <input type="time" id="adminReleaseTime" style="padding:5px;">
                    <button class="btn-action" onclick="saveReleaseTime()">Ulo≈æi≈•</button>
                </div>
            </div>
            <div class="config-block">
                <label>Kapacita:</label>
                <div style="display:flex; gap:5px;">
                    <input type="number" id="adminMaxCapacity" min="1" max="999" style="padding:5px; width:60px;">
                    <button class="btn-action" onclick="saveMaxCapacity()">Ulo≈æi≈•</button>
                </div>
            </div>
            
            <button onclick="uploadDefaults()" style="background:#222454; color:white; border:none; padding:8px 15px; cursor:pointer; font-weight:bold; border-radius:4px; margin-left:10px;">üöÄ NAHRA≈§ PREDVOLEN√â T√çMY</button>
            
            <button onclick="resetAllData()" style="background:#e74c3c; color:white; border:none; padding:8px 15px; cursor:pointer; font-weight:bold; border-radius:4px;">‚ö†Ô∏è FULL WIPE</button>
        </div>

        <div class="pin-manager">
            <h3>‚úÖ Potvrden√© t√≠my - Spr√°va</h3>
            <table class="pin-table">
                <thead><tr><th>T√≠m</th><th>Poƒçet hr√°ƒçov</th><th>Status</th><th>Akcie</th></tr></thead>
                <tbody id="adminConfirmedTableBody"></tbody>
            </table>
            <p style="text-align:center; color:#666; margin-top:15px; font-size:12px;">T√≠my, ktor√© potvrdili √∫ƒças≈•. M√¥≈æe≈° upravi≈• poƒçet hr√°ƒçov alebo odstr√°ni≈• t√≠m.</p>
            <button onclick="window.clearAllConfirmedTeams()" style="background:#e67e22; color:white; border:none; padding:8px 15px; cursor:pointer; font-weight:bold; border-radius:4px; margin-top:10px; width:100%;">üóëÔ∏è Vymaza≈• v≈°etky potvrden√© t√≠my</button>
        </div>

        <div class="pin-manager">
            <h3>üîê Spr√°va T√≠mov</h3>
            <table class="pin-table">
                <thead><tr><th>T√≠m</th><th>Predvolen√° Kap.</th><th>PIN</th><th>Akcie</th></tr></thead>
                <tbody id="adminPinTableBody"></tbody>
            </table>
            <button onclick="window.saveAllAdminTeams()" style="background:#27ae60; color:white; border:none; padding:10px 20px; cursor:pointer; font-weight:bold; border-radius:4px; margin-top:10px; width:100%;">üíæ Ulo≈æi≈• v≈°etky t√≠my naraz</button>
            <div class="add-team-form">
                <div class="form-group"><label>N√°zov:</label><input type="text" id="addTeamName"></div>
                <div class="form-group"><label>Kapacita:</label><input type="number" id="addTeamCap" value="4"></div>
                <div class="form-group"><label>PIN:</label><input type="text" id="addTeamPin" inputmode="numeric" pattern="[0-9]*" value="000"></div>
                <button class="btn-add" onclick="addNewTeam()">+ Prida≈• t√≠m</button>
            </div>
        </div>

        <div style="max-width: 95%; width: 95%; margin: 20px auto; text-align: right;">
            <button onclick="clearAllTableAssignments()" class="btn-stop" style="padding: 10px 20px; font-size: 13px;">üóëÔ∏è Vyƒçisti≈• v≈°etky stoly</button>
        </div>

        <div class="room-map">
            <div id="t1" class="table rect status-reserved" style="top:60px; left:80px;" onclick="adminEdit(this)" data-table-num="1"><span class="table-number">1</span>PU≈†KY<div class="cap-info">? os.</div></div>
            <div id="t2" class="table rect status-reserved" style="top:60px; left:210px;" onclick="adminEdit(this)" data-table-num="2"><span class="table-number">2</span>GURU TEAM<div class="cap-info">? os.</div></div>
            <div id="t3" class="table rect status-reserved" style="top:60px; left:340px;" onclick="adminEdit(this)" data-table-num="3"><span class="table-number">3</span>PIƒåI ZLA<div class="cap-info">? os.</div></div>
            <div id="t4" class="table rect status-reserved" style="top:60px; left:470px;" onclick="adminEdit(this)" data-table-num="4"><span class="table-number">4</span>MU≈†KY<div class="cap-info">? os.</div></div>
            <div id="t5" class="table circle status-reserved" style="top:250px; left:120px;" onclick="adminEdit(this)" data-table-num="5"><span class="table-number">5</span>STIBU<div class="cap-info">? os.</div></div>
            <div id="t6" class="table circle status-reserved" style="top:250px; left:240px;" onclick="adminEdit(this)" data-table-num="6"><span class="table-number">6</span>SPROST√ÅCI<div class="cap-info">? os.</div></div>
            <div id="t7" class="table circle status-reserved" style="top:250px; left:360px;" onclick="adminEdit(this)" data-table-num="7"><span class="table-number">7</span>F√âNIXOV R√ÅD<div class="cap-info">? os.</div></div>
            <div id="t8" class="table circle-small status-reserved" style="top:260px; left:480px;" onclick="adminEdit(this)" data-table-num="8"><span class="table-number">8</span>GEN Z<div class="cap-info">? os.</div></div>
            <div id="t9" class="table circle-small status-reserved" style="top:230px; left:570px;" onclick="adminEdit(this)" data-table-num="9"><span class="table-number">9</span>NEV√çDALI<div class="cap-info">? os.</div></div>
            <div id="t10" class="table circle-small status-reserved" style="top:100px; left:700px;" onclick="adminEdit(this)" data-table-num="10"><span class="table-number">10</span>≈ΩOL√çCI<div class="cap-info">? os.</div></div>
            <div id="t11" class="table circle-small status-reserved" style="top:80px; left:830px;" onclick="adminEdit(this)" data-table-num="11"><span class="table-number">11</span>FONT√ÅNA<div class="cap-info">? os.</div></div>
            <div id="t12" class="table circle status-free" style="top:330px; left:760px;" onclick="adminEdit(this)" data-table-num="12"><span class="table-number">12</span>Voƒæn√Ω<div class="cap-info">0 os.</div></div>
            <div id="t13" class="table rect status-free" style="top:450px; left:680px;" onclick="adminEdit(this)" data-table-num="13"><span class="table-number">13</span>Voƒæn√Ω<div class="cap-info">0 os.</div></div>
            <div id="t14" class="table rect status-free" style="top:500px; left:850px;" onclick="adminEdit(this)" data-table-num="14"><span class="table-number">14</span>Voƒæn√Ω<div class="cap-info">0 os.</div></div>
        </div>

        <!-- Web Content Editor -->
        <div class="pin-manager">
            <h3>üìù Web Content Editor</h3>
            <p style="text-align:center; color:#666; margin-bottom:20px; font-size:12px;">Upravte textov√Ω obsah na v≈°etk√Ωch str√°nkach webu. Zmeny sa ulo≈æia do Firestore.</p>
            
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <!-- Home Page Content -->
                <div style="flex: 1; min-width: 300px;">
                    <h4 style="color: #222454; border-bottom: 2px solid #222454; padding-bottom: 10px; margin-bottom: 15px;">üè† Domov (index.html)</h4>
                    <label>Hero - Nadpis:</label>
                    <input type="text" id="edit_home_hero_title" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Hero - Popis:</label>
                    <textarea id="edit_home_hero_description" class="admin-input" style="width: 100%; min-height: 60px; margin-bottom: 10px;"></textarea>
                    <label>Tlaƒçidlo - Rezervova≈•:</label>
                    <input type="text" id="edit_home_btn_reserve" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Tlaƒçidlo - Stiahnu≈•:</label>
                    <input type="text" id="edit_home_btn_download" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Fakt 1 - Nadpis:</label>
                    <input type="text" id="edit_home_fact1_title" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Fakt 1 - Text:</label>
                    <textarea id="edit_home_fact1_text" class="admin-input" style="width: 100%; min-height: 60px; margin-bottom: 10px;"></textarea>
                    <label>T√©ma kv√≠zu - Nadpis:</label>
                    <input type="text" id="edit_home_quiz_topic_title" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>T√©ma kv√≠zu - Text:</label>
                    <textarea id="edit_home_quiz_topic_text" class="admin-input" style="width: 100%; min-height: 60px; margin-bottom: 10px;"></textarea>
                    <label>T√©ma kv√≠zu - Link text:</label>
                    <input type="text" id="edit_home_quiz_topic_link" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Fakt 2 - Nadpis:</label>
                    <input type="text" id="edit_home_fact2_title" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Fakt 2 - Text:</label>
                    <textarea id="edit_home_fact2_text" class="admin-input" style="width: 100%; min-height: 60px; margin-bottom: 10px;"></textarea>
                    <button class="btn-save-pin" onclick="saveWebContent('home')" style="width: 100%; margin-top: 10px;">üíæ Ulo≈æi≈• Domov</button>
                </div>

                <!-- About Page Content -->
                <div style="flex: 1; min-width: 300px;">
                    <h4 style="color: #222454; border-bottom: 2px solid #222454; padding-bottom: 10px; margin-bottom: 15px;">‚ÑπÔ∏è O n√°s (onas.html)</h4>
                    <label>Kto sme - Nadpis:</label>
                    <input type="text" id="edit_about_who_title" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Kto sme - Text:</label>
                    <textarea id="edit_about_who_text" class="admin-input" style="width: 100%; min-height: 80px; margin-bottom: 10px;"></textarea>
                    <label>Preƒço pr√≠s≈• - Nadpis:</label>
                    <input type="text" id="edit_about_why_title" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Podnadpis 1:</label>
                    <input type="text" id="edit_about_why_subtitle1" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Text 1:</label>
                    <textarea id="edit_about_why_text1" class="admin-input" style="width: 100%; min-height: 60px; margin-bottom: 10px;"></textarea>
                    <label>Podnadpis 2:</label>
                    <input type="text" id="edit_about_why_subtitle2" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Text 2:</label>
                    <textarea id="edit_about_why_text2" class="admin-input" style="width: 100%; min-height: 60px; margin-bottom: 10px;"></textarea>
                    <label>Podnadpis 3:</label>
                    <input type="text" id="edit_about_why_subtitle3" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Text 3:</label>
                    <textarea id="edit_about_why_text3" class="admin-input" style="width: 100%; min-height: 60px; margin-bottom: 10px;"></textarea>
                    <label>Na≈°a cesta - Nadpis:</label>
                    <input type="text" id="edit_about_journey_title" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Cesta - Text 1:</label>
                    <textarea id="edit_about_journey_text1" class="admin-input" style="width: 100%; min-height: 40px; margin-bottom: 10px;"></textarea>
                    <label>Cesta - Text 2:</label>
                    <textarea id="edit_about_journey_text2" class="admin-input" style="width: 100%; min-height: 40px; margin-bottom: 10px;"></textarea>
                    <label>Cesta - Text 3:</label>
                    <textarea id="edit_about_journey_text3" class="admin-input" style="width: 100%; min-height: 40px; margin-bottom: 10px;"></textarea>
                    <label>Z√°vereƒçn√Ω text:</label>
                    <textarea id="edit_about_final_text" class="admin-input" style="width: 100%; min-height: 60px; margin-bottom: 10px;"></textarea>
                    <button class="btn-save-pin" onclick="saveWebContent('about')" style="width: 100%; margin-top: 10px;">üíæ Ulo≈æi≈• O n√°s</button>
                </div>

                <!-- App Page Content -->
                <div style="flex: 1; min-width: 300px;">
                    <h4 style="color: #222454; border-bottom: 2px solid #222454; padding-bottom: 10px; margin-bottom: 15px;">üì± Aplik√°cia (aplikacia.html)</h4>
                    <label>Hlavn√Ω nadpis:</label>
                    <input type="text" id="edit_app_main_title" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>QR k√≥d text:</label>
                    <input type="text" id="edit_app_qr_text" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Stiahnu≈• - Nadpis:</label>
                    <input type="text" id="edit_app_download_title" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Stiahnu≈• - Popis:</label>
                    <textarea id="edit_app_download_description" class="admin-input" style="width: 100%; min-height: 60px; margin-bottom: 10px;"></textarea>
                    <label>Tlaƒçidlo stiahnu≈•:</label>
                    <input type="text" id="edit_app_download_btn" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Preƒço vlastn√° - Nadpis:</label>
                    <input type="text" id="edit_app_why_title" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Preƒço vlastn√° - Text:</label>
                    <textarea id="edit_app_why_text" class="admin-input" style="width: 100%; min-height: 80px; margin-bottom: 10px;"></textarea>
                    <label>Ako funguje - Nadpis:</label>
                    <input type="text" id="edit_app_how_title" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Funkcia 1 - Nadpis:</label>
                    <input type="text" id="edit_app_feature1_title" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Funkcia 1 - Text:</label>
                    <textarea id="edit_app_feature1_text" class="admin-input" style="width: 100%; min-height: 50px; margin-bottom: 10px;"></textarea>
                    <label>Funkcia 2 - Nadpis:</label>
                    <input type="text" id="edit_app_feature2_title" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Funkcia 2 - Text:</label>
                    <textarea id="edit_app_feature2_text" class="admin-input" style="width: 100%; min-height: 50px; margin-bottom: 10px;"></textarea>
                    <label>Funkcia 3 - Nadpis:</label>
                    <input type="text" id="edit_app_feature3_title" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Funkcia 3 - Text:</label>
                    <textarea id="edit_app_feature3_text" class="admin-input" style="width: 100%; min-height: 50px; margin-bottom: 10px;"></textarea>
                    <label>Funkcia 4 - Nadpis:</label>
                    <input type="text" id="edit_app_feature4_title" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Funkcia 4 - Text:</label>
                    <textarea id="edit_app_feature4_text" class="admin-input" style="width: 100%; min-height: 50px; margin-bottom: 10px;"></textarea>
                    <label>Ako postupova≈• - Nadpis:</label>
                    <input type="text" id="edit_app_steps_title" class="admin-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Krok 1:</label>
                    <textarea id="edit_app_step1" class="admin-input" style="width: 100%; min-height: 40px; margin-bottom: 10px;"></textarea>
                    <label>Krok 2:</label>
                    <textarea id="edit_app_step2" class="admin-input" style="width: 100%; min-height: 40px; margin-bottom: 10px;"></textarea>
                    <label>Krok 3:</label>
                    <textarea id="edit_app_step3" class="admin-input" style="width: 100%; min-height: 40px; margin-bottom: 10px;"></textarea>
                    <label>Krok 4:</label>
                    <textarea id="edit_app_step4" class="admin-input" style="width: 100%; min-height: 40px; margin-bottom: 10px;"></textarea>
                    <label>Krok 5:</label>
                    <textarea id="edit_app_step5" class="admin-input" style="width: 100%; min-height: 40px; margin-bottom: 10px;"></textarea>
                    <button class="btn-save-pin" onclick="saveWebContent('app')" style="width: 100%; margin-top: 10px;">üíæ Ulo≈æi≈• Aplik√°cia</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // üìä LOGGING: Performance tracking
        const perf = {
            markers: {},
            mark: (name) => {
                perf.markers[name] = performance.now();
                console.log(`‚è±Ô∏è [${name}] ${perf.markers[name].toFixed(0)}ms`);
            },
            measure: (name, start, end) => {
                const duration = perf.markers[end] - perf.markers[start];
                console.log(`üìä [${name}] ${duration.toFixed(0)}ms`);
            }
        };
        
        console.log("üöÄ === FIREBASE LOADING ANALYSIS START ===");
        perf.mark('script-start');

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        console.log("‚úÖ Firebase App module imported");
        
        perf.mark('firestore-import-start');
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, deleteDoc, writeBatch } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        perf.mark('firestore-import-end');
        
        perf.mark('auth-import-start');
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        perf.mark('auth-import-end');

        const firebaseConfig = {
            apiKey: "AIzaSyCgKeENYtYJWf2_DZOw4irg6GPLq3XKhEc",
            authDomain: "quizbrothers-rezervacia.firebaseapp.com",
            projectId: "quizbrothers-rezervacia",
            storageBucket: "quizbrothers-rezervacia.firebasestorage.app",
            messagingSenderId: "193476216369",
            appId: "1:193476216369:web:8e0d59dd8282cb53ba3710",
            measurementId: "G-0LKTHWLKH5"
        };

        perf.mark('init-app-start');
        window.app = initializeApp(firebaseConfig);
        perf.mark('init-app-end');
        
        perf.mark('get-firestore-start');
        window.db = getFirestore(window.app);
        perf.mark('get-firestore-end');
        
        const app = window.app;
        const db = window.db;

        let authInstance = window.auth || getAuth(window.app);
        window.auth = authInstance;

        perf.measure('Firestore Import', 'firestore-import-start', 'firestore-import-end');
        perf.measure('Auth Import', 'auth-import-start', 'auth-import-end');
        perf.measure('InitializeApp', 'init-app-start', 'init-app-end');
        perf.measure('GetFirestore', 'get-firestore-start', 'get-firestore-end');

        let teamsData = []; 
        let globalSettings = { quizDate: null, masterPin: "9999", maxCapacity: 83, deadlineHour: 16, deadlineMinute: 30, releaseHour: 15, releaseMinute: 0 };
        let MAX_CAPACITY = 83;
        let autoCleanupTimeout = null;
        let autoReleaseTimeout = null;
        let pinModalPromise = null;

        // üöÄ OPTIMIZ√ÅCIA: IHNEƒé skry loading keƒè m√°me DEFAULT d√°ta
        console.time('‚è±Ô∏è Page Load Time');
        let firebaseTeamsLoaded = false;
        let firebaseSettingsLoaded = false;
        let overlayHidden = false;
        
        function tryHideLoadingOverlay() {
            if (overlayHidden) return;
            
            const overlay = document.getElementById('loadingOverlay');

            if (overlay) {
                console.log("‚úÖ D√°ta dostupn√© - skr√Ωvam loading");
                console.timeEnd('‚è±Ô∏è Page Load Time');
                overlay.style.display = 'none';
                overlayHidden = true;
            }
        }

        // Vyƒçistenie chybn√Ωch admin cache d√°t pri ≈°tarte
        (function() {
            try {
                const adminKey = 'qb_admin_texts';
                const cached = localStorage.getItem(adminKey);
                if (cached) {
                    const data = JSON.parse(cached);
                    // Ak s√∫ tam podozriv√© d√°ta (zmie≈°an√© texty), vyma≈æeme cache
                    const stringified = JSON.stringify(data);
                    if (stringified.includes('Rezervovan√©') || stringified.includes('Potvrden√©') || 
                        stringified.includes('displayCapacity') || stringified.includes('‚úî') ||
                        stringified.includes('‚úÖ') || stringified.match(/T√Ωm|t√≠m.*Poƒçet|hr√°ƒçov/)) {
                        console.log('üßπ ƒåistenie chybn√©ho admin cache...');
                        localStorage.removeItem(adminKey);
                    }
                }
            } catch (e) {
                console.log('Cache cleanup skipped');
            }
        })();

        // Custom PIN Modal Functions
        window.promptPin = function(message) {
            return new Promise((resolve) => {
                pinModalPromise = resolve;
                document.body.style.overflow = 'hidden';
                document.getElementById('pinModalOverlay').style.display = 'block';
                document.getElementById('pinModal').style.display = 'block';
                document.getElementById('pinModalInput').value = '';
                document.getElementById('pinModalInput').focus();
                
                // Auto-focus a povolenie enterom
                document.getElementById('pinModalInput').onkeypress = function(e) {
                    if (e.key === 'Enter') {
                        window.confirmPin();
                    }
                };
            });
        };

        window.confirmPin = function() {
            const pin = document.getElementById('pinModalInput').value;
            document.body.style.overflow = 'auto';
            document.getElementById('pinModalOverlay').style.display = 'none';
            document.getElementById('pinModal').style.display = 'none';
            if (pinModalPromise) {
                pinModalPromise(pin);
                pinModalPromise = null;
            }
        };

        window.cancelPin = function() {
            document.body.style.overflow = 'auto';
            document.getElementById('pinModalOverlay').style.display = 'none';
            document.getElementById('pinModal').style.display = 'none';
            if (pinModalPromise) {
                pinModalPromise(null);
                pinModalPromise = null;
            }
        };

        const defaultTeamsList = [
            { id: "Mu≈°ky", default: 7, pin: "111", current: 0, confirmed: false, declined: false },
            { id: "Pu≈°ky", default: 7, pin: "222", current: 0, confirmed: false, declined: false },
            { id: "Piƒçi Zla", default: 7, pin: "333", current: 0, confirmed: false, declined: false },
            { id: "Guru Team", default: 7, pin: "444", current: 0, confirmed: false, declined: false },
            { id: "Stibu", default: 6, pin: "555", current: 0, confirmed: false, declined: false },
            { id: "Gen Z", default: 4, pin: "666", current: 0, confirmed: false, declined: false },
            { id: "Font√°na", default: 3, pin: "777", current: 0, confirmed: false, declined: false },
            { id: "F√©nixov r√°d", default: 5, pin: "888", current: 0, confirmed: false, declined: false },
            { id: "Sprost√°ci", default: 5, pin: "101", current: 0, confirmed: false, declined: false },
            { id: "≈Ωol√≠ci", default: 3, pin: "102", current: 0, confirmed: false, declined: false },
            { id: "Nev√≠dali", default: 3, pin: "103", current: 0, confirmed: false, declined: false }
        ];
        
        teamsData = JSON.parse(JSON.stringify(defaultTeamsList));

        // üöÄ OPTIMIZ√ÅCIA: Naƒç√≠taj cache IHNEƒé PRED Firebase listenermi
        const cachedTeams = localStorage.getItem('teams_cache');
        if (cachedTeams) {
            try {
                teamsData = JSON.parse(cachedTeams);
                console.log("‚ö° Teams z cache");
            } catch(e) {
                console.log("Cache teams invalid - pou≈æ√≠vam DEFAULT");
            }
        }

        const cachedSettings = localStorage.getItem('settings_cache');
        if (cachedSettings) {
            try {
                globalSettings = JSON.parse(cachedSettings);
                console.log("‚ö° Settings z cache");
            } catch(e) {
                console.log("Cache settings invalid - pou≈æ√≠vam DEFAULT");
            }
        }
        
        // üöÄ OPTIMIZ√ÅCIA: IHNEƒé zobraz DEFAULT d√°ta - SKRY LOADING!
        updateDashboard();
        populateTeamSelect();
        updateHeaderDate();
        checkDeadline();
        tryHideLoadingOverlay(); // SKRY loading teraz - m√°me DEFAULT d√°ta!

        // üìä FIREBASE LISTENERS START
        perf.mark('snapshot-teams-start');
        onSnapshot(collection(db, "teams"), (snapshot) => {
            perf.mark('snapshot-teams-received');
            console.log(`üì¶ Teams snapshot prijat√Ω - ${perf.markers['snapshot-teams-received'] - perf.markers['snapshot-teams-start']}ms od otvorenia listenera`);
            console.log(`üì¶ Poƒçet dokumentov: ${snapshot.size}`);
            console.log(`üì¶ ƒåas od ≈°tartu str√°nky: ${(perf.markers['snapshot-teams-received'] - perf.markers['script-start']).toFixed(0)}ms`);
            teamsData = [];
            snapshot.forEach(doc => { teamsData.push({ id: doc.id, ...doc.data() }); });
            
            localStorage.setItem('teams_cache', JSON.stringify(teamsData));
            console.log("‚úÖ Teams z Firebase s√∫ hotov√©");
            
            updateDashboard(); 
            populateTeamSelect(); 
            
            const activeElement = document.activeElement;
            const isEditingInTable = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA') && 
                                    (activeElement.closest('#adminConfirmedTableBody, #adminPinTableBody'));
            
            if (!isEditingInTable) {
                renderAdminPinTable(); 
                loadTableAssignments().then(() => updateMapVisuals());
            }
            
            firebaseTeamsLoaded = true;
            tryHideLoadingOverlay();
        }, (error) => {
            console.error("‚ùå Chyba pri naƒç√≠tan√≠ t√≠mov:", error);
            firebaseTeamsLoaded = true;
            tryHideLoadingOverlay();
        });

        perf.mark('snapshot-settings-start');
        onSnapshot(doc(db, "config", "settings"), (docSnap) => {
            perf.mark('snapshot-settings-received');
            console.log(`‚öôÔ∏è Settings snapshot prijat√Ω - ${perf.markers['snapshot-settings-received'] - perf.markers['snapshot-settings-start']}ms od otvorenia listenera`);
            console.log(`‚öôÔ∏è ƒåas od ≈°tartu str√°nky: ${(perf.markers['snapshot-settings-received'] - perf.markers['script-start']).toFixed(0)}ms`);
            if (docSnap.exists()) {
                const data = docSnap.data();
                globalSettings = {
                    quizDate: data.quizDate || null,
                    masterPin: data.masterPin || "9999",
                    deadlineHour: data.deadlineHour || 16,
                    deadlineMinute: data.deadlineMinute || 30,
                    maxCapacity: data.maxCapacity || 83,
                    releaseHour: data.releaseHour || 15,
                    releaseMinute: data.releaseMinute || 0
                };
                MAX_CAPACITY = globalSettings.maxCapacity;
                localStorage.setItem('settings_cache', JSON.stringify(globalSettings));
                console.log("‚úÖ Settings z Firebase s√∫ hotov√©");
            } else {
                setDoc(doc(db, "config", "settings"), { quizDate: null, masterPin: "9999", deadlineHour: 16, deadlineMinute: 30, maxCapacity: 83, releaseHour: 15, releaseMinute: 0 });
            }
            
            updateHeaderDate(); 
            checkDeadline();
            if(document.getElementById('adminQuizDate')) document.getElementById('adminQuizDate').value = globalSettings.quizDate || "";
            // Aktualizuj vstupy len ak s√∫ pr√°zdne (prv√Ω load), nie pri ka≈ædej Firebase zmene
            if(document.getElementById('adminQuizDate') && !document.getElementById('adminQuizDate').value) {
                document.getElementById('adminQuizDate').value = globalSettings.quizDate || "";
            }
            if(document.getElementById('adminDeadlineTime') && !document.getElementById('adminDeadlineTime').value) {
                const hour = String(globalSettings.deadlineHour).padStart(2, '0');
                const minute = String(globalSettings.deadlineMinute).padStart(2, '0');
                document.getElementById('adminDeadlineTime').value = `${hour}:${minute}`;
            }
            if(document.getElementById('adminReleaseTime') && !document.getElementById('adminReleaseTime').value) {
                const hour = String(globalSettings.releaseHour).padStart(2, '0');
                const minute = String(globalSettings.releaseMinute).padStart(2, '0');
                document.getElementById('adminReleaseTime').value = `${hour}:${minute}`;
            }
            if(document.getElementById('adminMaxCapacity') && !document.getElementById('adminMaxCapacity').value) {
                document.getElementById('adminMaxCapacity').value = globalSettings.maxCapacity || 83;
            }
            
            const reservedDisplay = document.getElementById('reservedDeadlineDisplay');
            if (reservedDisplay) {
                const hour = String(globalSettings.releaseHour || 15).padStart(2, '0');
                const minute = String(globalSettings.releaseMinute || 0).padStart(2, '0');
                reservedDisplay.innerText = `${hour}:${minute}`;
            }
            
            if (globalSettings.quizDate) {
                scheduleAutoCleanup();
                scheduleAutoRelease();
            }
            updateDashboard();
            
            firebaseSettingsLoaded = true;
            tryHideLoadingOverlay();
        }, (error) => {
            console.error("‚ùå Chyba pri naƒç√≠tan√≠ nastaven√≠:", error);
            console.log("Settings error type:", error.code);
            const cached = localStorage.getItem('settings_cache');
            if (cached) {
                try {
                    globalSettings = JSON.parse(cached);
                    console.log("‚úÖ Settings naƒç√≠tan√© z cache (fallback)");
                } catch(e) {
                    console.error("Chyba pri naƒç√≠tan√≠ cache nastaven√≠");
                }
            }
            firebaseSettingsLoaded = true;
            tryHideLoadingOverlay();
        });

        // üöÄ OPTIMIZ√ÅCIA: Inicializ√°cia event listenerov bez zbytoƒçn√©ho delay
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
            submitBtn.addEventListener('click', async function(e) {
                console.log('üîµ === SUBMIT BUTTON CLICK EVENT ===');
                console.log('Event type:', e.type);
                console.log('Event target:', e.target);
                e.preventDefault();
                await window.handleFormSubmit(e);
            });
        }
        
        const playerCountInput = document.getElementById('playerCount');
        if (playerCountInput) {
            playerCountInput.addEventListener('change', function() {
                checkDeadline();
            });
            playerCountInput.addEventListener('input', function() {
                checkDeadline();
            });
            // Enter v poƒæe Poƒçet hr√°ƒçov klikne na tlaƒçidlo
            playerCountInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    console.log('üü¢ === ENTER IN PLAYER COUNT ===');
                    e.preventDefault();
                    console.log('Clicking submit button...');
                    document.getElementById('submitBtn').click();
                }
            });
        }
        
        // Enter v poƒæe N√°zov nov√©ho t√≠mu klikne na tlaƒçidlo
        const customTeamInput = document.getElementById('customTeamName');
        if (customTeamInput) {
            customTeamInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    console.log('üü¢ === ENTER IN CUSTOM TEAM NAME ===');
                    e.preventDefault();
                    console.log('Clicking submit button...');
                    document.getElementById('submitBtn').click();
                }
            });
        }
        
        // Enter v poƒæe PIN k√≥d klikne na tlaƒçidlo
        const teamPinInput = document.getElementById('teamPin');
        if (teamPinInput) {
            teamPinInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    console.log('üü¢ === ENTER IN PIN INPUT ===');
                    e.preventDefault();
                    console.log('Clicking submit button...');
                    document.getElementById('submitBtn').click();
                }
            });
        }

        window.handleTeamChange = function() {
            const select = document.getElementById('teamSelect');
            const customInputDiv = document.getElementById('newTeamInput');
            const countInput = document.getElementById('playerCount');
            const pinLabel = document.getElementById('pinLabel');
            const pinHelp = document.getElementById('pinHelp');
            const teamReservedInfo = document.getElementById('teamReservedInfo');
            const cancelBtn = document.getElementById('cancelBtn');
            const declineBtn = document.getElementById('declineBtn');
            const customTeamInput = document.getElementById('customTeamName');
            const releaseInFuture = isReleaseTimeInFuture();
            
            // ‚úÖ PIN SEKCIA JE V≈ΩDY VIDITEƒΩN√Å - neskr√Ωvame ju!
            
            if (select.value === 'new') {
                customInputDiv.style.display = 'block';
                countInput.value = 4;
                teamReservedInfo.style.display = 'none';
                declineBtn.style.display = 'none';
                
                // Nadpisy PIN sekcie pre nov√Ω t√≠m
                pinLabel.innerText = "Vytvor si PIN k√≥d:";
                pinHelp.innerText = "Zapam√§taj si ho pre bud√∫ce zmeny a zmenu √∫ƒçasti.";
                
                const customName = customTeamInput.value.trim();
                if (customName) {
                    const existingTeam = teamsData.find(t => t.id === customName);
                    if (existingTeam && existingTeam.confirmed) {
                        pinLabel.innerText = "Zadaj PIN k√≥d:";
                        pinHelp.innerText = "Potrebn√Ω na zmenu alebo zru≈°enie √∫ƒçasti.";
                        teamReservedInfo.style.display = 'block';
                        teamReservedInfo.innerText = `‚úÖ Tento t√≠m je u≈æ potvrden√Ω s ${existingTeam.current} os.!`;
                        teamReservedInfo.style.color = '#27ae60';
                        cancelBtn.style.display = 'block';
                        countInput.value = existingTeam.current;
                    } else {
                        cancelBtn.style.display = 'none';
                    }
                } else {
                    cancelBtn.style.display = 'none';
                }
            } else {
                customInputDiv.style.display = 'none';
                const team = teamsData.find(t => t.id === select.value);
                if (team) {
                    // Nastav PIN label podƒæa typu t√≠mu
                    pinLabel.innerText = `Zadaj PIN pre t√≠m ${select.value}:`;
                    pinHelp.innerText = "Potrebn√Ω pre zmenu alebo zru≈°enie √∫ƒçasti.";
                    
                    // Zobraz inform√°cie na z√°klade ƒçasu uvoƒænenia
                    if (team.isStatic && !team.confirmed && releaseInFuture) {
                        teamReservedInfo.style.display = 'block';
                        teamReservedInfo.innerText = `‚è≥ Rezervovan√Ω poƒçet: ${team.default} os.`;
                        teamReservedInfo.style.color = '#222454';
                        cancelBtn.style.display = 'none';
                        declineBtn.style.display = 'block';
                    } else if (team.confirmed) {
                        teamReservedInfo.style.display = 'block';
                        teamReservedInfo.innerText = `‚úÖ Potvrden√Ω poƒçet: ${team.current} os.`;
                        teamReservedInfo.style.color = '#27ae60';
                        cancelBtn.style.display = 'block';
                        declineBtn.style.display = 'none';
                    } else {
                        teamReservedInfo.style.display = 'none';
                        cancelBtn.style.display = 'none';
                        declineBtn.style.display = 'none';
                    }
                    countInput.value = team.current || team.default || 4;
                } else {
                    teamReservedInfo.style.display = 'none';
                    cancelBtn.style.display = 'none';
                    declineBtn.style.display = 'none';
                    pinLabel.innerText = `Zadaj PIN pre t√≠m ${select.value}:`;
                    pinHelp.innerText = "Ak si zabudol PIN, kontaktuj organiz√°tora.";
                }
            }
            checkDeadline();
        }

        window.handleFormSubmit = async function(e) {
            console.log('üî¥ === HANDLE FORM SUBMIT START ===');
            console.log('Event:', e);
            
            // üéØ BLUR v≈°etky inputy aby updateDashboard nebol blokovan√Ω
            const activeEl = document.activeElement;
            if (activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.tagName === 'SELECT')) {
                console.log('Blurring active element:', activeEl);
                activeEl.blur();
            }
            
            if (e && e.preventDefault) {
                e.preventDefault();
            }
            console.log("üîç Form submit iniciovan√Ω!");
            
            const count = parseInt(document.getElementById('playerCount').value) || 4;
            let enteredPin = document.getElementById('teamPin').value;
            const teamSelect = document.getElementById('teamSelect').value;
            
            if (!checkDeadline()) {
                console.log("‚ùå Deadline check nepre≈°iel!");
                return;
            }

            let currentTeamCount = 0;
            if (teamSelect !== 'new') {
                const existing = teamsData.find(t => t.id === teamSelect);
                if(existing) currentTeamCount = existing.current;
            } else {
                const newName = document.getElementById('customTeamName').value;
                const existing = teamsData.find(t => t.id === newName);
                if(existing) currentTeamCount = existing.current;
            }

            const currentOccupied = calculateOccupied();
            const diff = count - currentTeamCount;
            const remaining = MAX_CAPACITY - currentOccupied;
            
            if (diff > 0 && (currentOccupied + diff) > MAX_CAPACITY) { alert("Kapacita je pln√° - m√¥≈æe≈° iba zn√≠≈æi≈• poƒçet √∫ƒçastn√≠kov."); return; }

            try {
                if (teamSelect !== 'new') {
                    const team = teamsData.find(t => t.id === teamSelect);
                    if (!team) {
                        alert("‚ùå T√≠m nebol n√°jden√Ω!");
                        return;
                    }
                    
                    // üîê PIN MUS√ç BY≈§ V≈ΩDY VALIDOVAN√ù, NIKDY SKIPOVA≈§!
                    if (!enteredPin || !enteredPin.trim()) {
                        const promptedPin = await window.promptPin("‚ùì Zadaj PIN k√≥d:");
                        if (!promptedPin) {
                            return;
                        }
                        enteredPin = promptedPin;
                    }
                    
                    const pinTrimmed = enteredPin.trim();
                    const teamPinTrimmed = String(team.pin || "").trim();
                    const masterPinTrimmed = String(globalSettings.masterPin || "").trim();
                    
                    if (pinTrimmed !== teamPinTrimmed && pinTrimmed !== masterPinTrimmed) {
                        alert("‚ùå Nespr√°vny PIN!");
                        return;
                    }
                    
                    // Zapam√§taj si, ƒçi t√≠m u≈æ bol potvrden√Ω pred updatom
                    const wasAlreadyConfirmed = team.confirmed === true;
                    
                    console.log("üìù Sk√∫≈°am updatova≈• t√≠m:", team.id, { current: count, confirmed: true });
                    try {
                        await updateDoc(doc(db, "teams", team.id), { current: count, confirmed: true });
                        console.log("‚úÖ T√≠m √∫spe≈°ne updatovan√Ω!");
                        
                        // üìç EXPLICITNE aktualizuj lok√°lne d√°ta IHNEƒé
                        team.current = count;
                        team.confirmed = true;
                        localStorage.setItem('teams_cache', JSON.stringify(teamsData));
                        
                        console.log('üü° Calling updateDashboard()...');
                        // üìç IHNEƒé aktualizuj UI
                        updateDashboard();
                        console.log('üü° Calling populateTeamSelect()...');
                        populateTeamSelect();
                        console.log('üü° Calling renderAdminPinTable()...');
                        renderAdminPinTable();
                        console.log('üü° UI update complete!');
                    } catch (updateErr) {
                        console.warn("‚ö†Ô∏è updateDoc chyba (mo≈æno offline):", updateErr);
                        throw updateErr;
                    }
                    
                    // Rozl√≠≈° prv√© potvrdenie vs. aktualiz√°ciu
                    const message = wasAlreadyConfirmed 
                        ? `‚úÖ T√≠m ${team.id} aktualizovan√Ω!` 
                        : `‚úÖ T√≠m ${team.id} potvrden√Ω!`;
                    document.getElementById('formMessage').innerText = message;
                    document.getElementById('formMessage').style.color = 'green';
                } else {
                    const newName = document.getElementById('customTeamName').value.trim();
                    if (!newName) {
                        alert("‚ùå Zadaj n√°zov t√≠mu!");
                        return;
                    }
                    
                    // üîê PIN MUS√ç BY≈§ V≈ΩDY ZADAN√ù A VALIDOVAN√ù!
                    let newTeamPin = document.getElementById('teamPin').value.trim();
                    if (!newTeamPin) {
                        alert("‚ùå Zadaj si PIN k√≥d pre nov√Ω t√≠m!");
                        return;
                    }
                    
                    const existing = teamsData.find(t => t.id === newName);
                    if (existing) {
                        // üîê AJ EXISTUJ√öCI T√çM MUS√ç M√Å≈§ VALIDOVAN√ù PIN
                        const pinTrimmed = newTeamPin;
                        const existingPinTrimmed = String(existing.pin || "").trim();
                        const masterPinTrimmed = String(globalSettings.masterPin || "").trim();
                        if (pinTrimmed !== existingPinTrimmed && pinTrimmed !== masterPinTrimmed) {
                            alert("‚ùå T√≠m u≈æ existuje. Zl√Ω PIN.");
                            return;
                        }
                        
                        // Zapam√§taj si, ƒçi t√≠m u≈æ bol potvrden√Ω pred updatom
                        const wasAlreadyConfirmed = existing.confirmed === true;
                        
                        await updateDoc(doc(db, "teams", newName), { current: count, confirmed: true });
                        
                        // üìç EXPLICITNE aktualizuj lok√°lne d√°ta IHNEƒé
                        existing.current = count;
                        existing.confirmed = true;
                        localStorage.setItem('teams_cache', JSON.stringify(teamsData));
                        
                        // üìç IHNEƒé aktualizuj UI
                        updateDashboard();
                        populateTeamSelect();
                        renderAdminPinTable();
                        
                        // Rozl√≠≈° prv√© potvrdenie vs. aktualiz√°ciu
                        const message = wasAlreadyConfirmed 
                            ? `‚úÖ T√≠m ${newName} aktualizovan√Ω!` 
                            : `‚úÖ T√≠m ${newName} potvrden√Ω!`;
                        document.getElementById('formMessage').innerText = message;
                        document.getElementById('formMessage').style.color = 'green';
                    } else {
                        // üîê NOV√ù T√çM MUS√ç M√Å≈§ PIN - JE JU≈Ω OVEREN√ù
                        await setDoc(doc(db, "teams", newName), {
                            default: count, current: count, pin: newTeamPin, confirmed: true, isStatic: false, tableId: "", declined: false
                        });
                        
                        // üìç EXPLICITNE prid√°m nov√Ω t√≠m do lok√°lnych d√°t IHNEƒé
                        teamsData.push({
                            id: newName,
                            default: count,
                            current: count,
                            pin: newTeamPin,
                            confirmed: true,
                            isStatic: false,
                            tableId: "",
                            declined: false
                        });
                        localStorage.setItem('teams_cache', JSON.stringify(teamsData));
                        
                        // üìç IHNEƒé aktualizuj UI
                        updateDashboard();
                        populateTeamSelect();
                        renderAdminPinTable();
                        
                        document.getElementById('formMessage').innerText = `‚úÖ T√≠m ${newName} zaregistrovan√Ω!`;
                        document.getElementById('formMessage').style.color = 'green';
                    }
                }
                
                // ‚è±Ô∏è Delay reset a handleTeamChange aby Firebase listener stihol aktualizova≈• UI
                setTimeout(() => {
                    document.getElementById('quizForm').reset();
                    if (window.handleTeamChange) {
                        window.handleTeamChange();
                    }
                }, 300);
            } catch (err) {
                console.error("Chyba pri odosielan√≠:", err);
                alert("‚ùå Chyba: " + err.message);
                document.getElementById('formMessage').innerText = "‚ùå Chyba pri odosielan√≠: " + err.message;
                document.getElementById('formMessage').style.color = 'red';
            }
        }

        function isReleaseTimeInFuture() {
            if (!globalSettings.quizDate) return true;
            const now = new Date();
            const releaseHour = globalSettings.releaseHour || 15;
            const releaseMinute = globalSettings.releaseMinute || 0;
            const releaseTime = new Date(`${globalSettings.quizDate}T${String(releaseHour).padStart(2, '0')}:${String(releaseMinute).padStart(2, '0')}:00`);
            return now < releaseTime;
        }

        function calculateOccupied() { 
            const releaseInFuture = isReleaseTimeInFuture();
            return teamsData.reduce((sum, t) => {
                // Ak je ƒças uvoƒænenia v bud√∫cnosti, statick√© t√≠my maj√∫ Reserved miesto (default hodnota)
                if (releaseInFuture && t.isStatic && !t.confirmed) {
                    return sum + (t.default || 0);
                }
                // Ak je ƒças uvoƒænenia v minulosti a t√≠m je statick√Ω a nepotvrden√Ω, nepoƒç√≠taj ho
                if (!releaseInFuture && t.isStatic && !t.confirmed) {
                    return sum;
                }
                // Potvrden√© t√≠my (ƒçi statick√© alebo nie) sa poƒç√≠taj√∫ ako current
                return sum + t.current;
            }, 0);
        }

        function populateTeamSelect() {
            const select = document.getElementById('teamSelect');
            select.innerHTML = '<option value="new">Nov√Ω t√≠m / Vybra≈• t√≠m</option>';
            
            // ‚úÖ ZMENA: Filtruj statick√© t√≠my podƒæa ƒçasu uvoƒænenia
            const releaseInFuture = isReleaseTimeInFuture();
            
            teamsData.filter(t => {
                if (t.confirmed) return true; // Potvrden√© t√≠my v≈ædy dostupn√©
                if (t.isStatic && releaseInFuture) return true; // Statick√© t√≠my len ak je ƒças v bud√∫cnosti
                return false;
            }).forEach(t => {
                let opt = document.createElement('option');
                opt.value = t.id; opt.innerText = t.id; select.appendChild(opt);
            });
            
            // ‚úÖ V≈ædy aktualizuj PIN sekciu keƒè sa zmenia t√≠my - ale bezpeƒçne
            try {
                setTimeout(() => {
                    if (window.handleTeamChange) {
                        window.handleTeamChange();
                    }
                }, 10);
            } catch (e) {
                console.log("Note: handleTeamChange delayed call");
            }
        }

        function updateDashboard() {
            const activeElement = document.activeElement;
            if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA' || activeElement.tagName === 'SELECT')) {
                return;
            }
            
            const occupied = calculateOccupied();
            const remaining = MAX_CAPACITY - occupied;
            const display = document.getElementById('displayCapacity');
            
            if (!display.hasAttribute('data-text-id') && display.textContent !== 'Zost√°va voƒæn√Ωch miest:') {
                display.innerText = `${remaining} / ${MAX_CAPACITY}`;
            }
            
            display.className = "capacity-number"; 
            if (remaining <= 0) { 
                display.innerText = "PLNO"; 
                display.classList.add('cap-crit'); 
                disableForm("PLNO"); 
            }
            else if (remaining < 10) display.classList.add('cap-crit');
            else if (remaining <= 20) display.classList.add('cap-warn');
            else display.classList.add('cap-safe');

            const listReserved = document.getElementById('listReserved');
            const listConfirmed = document.getElementById('listConfirmed');
            
            const reservedContent = [];
            const confirmedContent = [];
            
            const releaseHour = String(globalSettings.releaseHour || 15).padStart(2, '0');
            const releaseMinute = String(globalSettings.releaseMinute || 0).padStart(2, '0');
            
            // ‚úÖ NOV√Å LOGIKA: Zisti ƒçi je ƒças uvoƒænenia v bud√∫cnosti alebo minulosti
            const releaseInFuture = isReleaseTimeInFuture();
            
            teamsData.forEach(t => {
                const li = document.createElement('li'); 
                li.className = 'team-item';
                if (t.confirmed) {
                    li.innerHTML = `${t.id} <span class="badge-count badge-confirmed">${t.current} ‚úî</span>`;
                    confirmedContent.push(li);
                } else if (t.isStatic !== false) {
                    // ‚úÖ ZMENA: Zobrazuj statick√© t√≠my LEN ak je ƒças uvoƒænenia v bud√∫cnosti A ak NEUVEDLI "Nepr√≠deme" (declined !== true)
                    if (releaseInFuture && t.declined !== true) {
                        li.innerHTML = `${t.id} <span class="badge-count">${t.default} os.</span>`;
                        reservedContent.push(li);
                    }
                    // Ak je ƒças uvoƒænenia v minulosti alebo declined == true, nezobrazuj
                }
            });
            
            // ‚úÖ ZMENA: Zobraz spr√°vu keƒè je ƒças uvoƒænenia v minulosti a nie s√∫ ≈æiadne individu√°lne rezervovan√© t√≠my
            if (!releaseInFuture && reservedContent.length === 0) {
                const li = document.createElement('li');
                li.className = 'team-item';
                li.innerHTML = `<span style="color:#999; font-size:14px;">‚è≥ Rezervovan√© (do ${releaseHour}:${releaseMinute})<br/>Rezerv√°ciu bolo potrebn√© potvrdi≈• do ${releaseHour}:${releaseMinute} - ak je st√°le voƒæn√© miesto, m√¥≈æete sa prida≈•</span>`;
                reservedContent.push(li);
            }
            
            listReserved.innerHTML = "";
            listConfirmed.innerHTML = "";
            reservedContent.forEach(item => listReserved.appendChild(item));
            confirmedContent.forEach(item => listConfirmed.appendChild(item));
            
            populateTeamSelect();
            checkDeadline();
        }

        function checkDeadline() {
            const btn = document.getElementById('submitBtn');
            if (!globalSettings.quizDate) { if(btn) { btn.disabled = true; btn.innerText = "ƒåak√° sa na spustenie"; } return false; }
            const now = new Date();
            const deadlineHour = globalSettings.deadlineHour || 16;
            const deadlineMinute = globalSettings.deadlineMinute || 30;
            const deadline = new Date(`${globalSettings.quizDate}T${String(deadlineHour).padStart(2, '0')}:${String(deadlineMinute).padStart(2, '0')}:00`);
            if (now > deadline) { if(btn) { btn.disabled = true; btn.innerText = "Registr√°cia ukonƒçen√°"; } return false; }
            
            const remaining = MAX_CAPACITY - calculateOccupied();
            const teamSelect = document.getElementById('teamSelect');
            const playerCountInput = document.getElementById('playerCount');
            const isFull = remaining <= 0;
            
            if (isFull && btn) {
                let currentTeamCount = 0;
                if (teamSelect && teamSelect.value !== 'new') {
                    const existing = teamsData.find(t => t.id === teamSelect.value);
                    if(existing) currentTeamCount = existing.current;
                } else if (document.getElementById('customTeamName')) {
                    const newName = document.getElementById('customTeamName').value;
                    const existing = teamsData.find(t => t.id === newName);
                    if(existing) currentTeamCount = existing.current;
                }
                
                const newCount = parseInt(playerCountInput.value) || 4;
                const willDecrease = newCount < currentTeamCount;
                
                if (willDecrease) {
                    btn.disabled = false;
                    btn.innerText = "Potvrdi≈• zmenu (‚Üì uvoƒæ≈àuje≈° miesto)";
                } else {
                    btn.disabled = true;
                    btn.innerText = "PLNO - zmeni≈• iba na men≈°√≠ poƒçet";
                }
            } else if (btn && remaining > 0) { 
                btn.disabled = false; 
                btn.innerText = "Potvrdi≈• √∫ƒças≈•"; 
            }
            return true;
        }

        function disableForm(msg) { const btn = document.getElementById('submitBtn'); if(btn) { btn.disabled = true; btn.innerText = msg; } }

        function updateHeaderDate() {
            const dateEl = document.getElementById('publicQuizDate');
            const deadEl = document.getElementById('publicDeadlineInfo');
            const reservedDisplay = document.getElementById('reservedDeadlineDisplay');
            if (globalSettings.quizDate) {
                const d = new Date(globalSettings.quizDate);
                const deadlineHour = globalSettings.deadlineHour || 16;
                const deadlineMinute = globalSettings.deadlineMinute || 30;
                const releaseHour = globalSettings.releaseHour || 15;
                const releaseMinute = globalSettings.releaseMinute || 0;
                dateEl.innerText = `Kv√≠z sa kon√°: ${d.getDate()}.${d.getMonth()+1}.${d.getFullYear()}`;
                dateEl.style.color = "#222454";
                deadEl.innerText = `‚ö†Ô∏è Registr√°cia do: ${d.getDate()}.${d.getMonth()+1}. ${String(deadlineHour).padStart(2, '0')}:${String(deadlineMinute).padStart(2, '0')}`;
                if (reservedDisplay) {
                    reservedDisplay.innerText = `${String(releaseHour).padStart(2, '0')}:${String(releaseMinute).padStart(2, '0')}`;
                }
                
                scheduleAutoCleanup();
                updateDashboard();
            } else {
                dateEl.innerText = "Term√≠n najbli≈æ≈°ieho kv√≠zu zatiaƒæ nie je urƒçen√Ω.";
                dateEl.style.color = "#666"; deadEl.innerText = "";
                
                cancelAutoCleanup();
                cancelAutoRelease();
                updateDashboard();
            }
        }
        
        function scheduleAutoCleanup() {
            cancelAutoCleanup();
            
            if (!globalSettings.quizDate) return;
            
            const quizDate = new Date(globalSettings.quizDate);
            const nextDay = new Date(quizDate);
            nextDay.setDate(nextDay.getDate() + 1);
            nextDay.setHours(0, 0, 0, 0);
            
            const now = new Date();
            const timeUntilMidnight = nextDay.getTime() - now.getTime();
            
            if (timeUntilMidnight > 0) {
                console.log(`‚è∞ Automatick√© ƒçistenie napl√°novan√© na: ${nextDay.toLocaleString()}`);
                autoCleanupTimeout = setTimeout(async () => {
                    console.log("üßπ Sp√∫≈°≈•am automatick√© ƒçistenie potvrden√Ωch t√≠mov...");
                    const today = new Date();
                    if (today > nextDay) {
                        await window.clearAllConfirmedTeams();
                    }
                }, timeUntilMidnight);
            }
        }
        
        function cancelAutoCleanup() {
            if (autoCleanupTimeout) {
                clearTimeout(autoCleanupTimeout);
                autoCleanupTimeout = null;
                console.log("‚ùå Automatick√© ƒçistenie zru≈°en√©");
            }
        }

        function scheduleAutoRelease() {
            cancelAutoRelease();
            
            if (!globalSettings.quizDate) return;
            
            const quizDate = new Date(globalSettings.quizDate);
            const releaseHour = globalSettings.releaseHour || 15;
            const releaseMinute = globalSettings.releaseMinute || 0;
            
            const releaseTime = new Date(quizDate);
            releaseTime.setHours(releaseHour, releaseMinute, 0, 0);
            
            const now = new Date();
            const timeUntilRelease = releaseTime.getTime() - now.getTime();
            
            if (timeUntilRelease > 0) {
                console.log(`‚è∞ Automatick√© uvoƒænenie napl√°novan√© na: ${releaseTime.toLocaleString()}`);
                autoReleaseTimeout = setTimeout(async () => {
                    console.log("üîì Sp√∫≈°≈•am automatick√© uvoƒænenie miest od nepotvrden√Ωch rezervovan√Ωch t√≠mov...");
                    try {
                        const batch = writeBatch(db);
                        teamsData.forEach(team => {
                            // Len statick√© t√≠my, ktor√© NEPOTVRDILI - vr√°≈• ich poƒçet na 0
                            if (team.isStatic && !team.confirmed) {
                                const ref = doc(db, "teams", team.id);
                                batch.update(ref, { current: 0 });
                            }
                            // Potvrden√© t√≠my (bez ohƒæadu ƒçi s√∫ statick√© alebo nie) ostan√∫ nezmenen√©!
                        });
                        await batch.commit();
                        console.log("‚úÖ Miesta od nepotvrden√Ωch t√≠mov boli √∫spe≈°ne uvoƒænen√©!");
                        updateDashboard();
                        populateTeamSelect();
                    } catch (err) {
                        console.error("‚ùå Chyba pri uvoƒæ≈àovan√≠ miest:", err);
                    }
                }, timeUntilRelease);
            } else {
                console.log("‚è∞ Uvoƒænenie u≈æ prebehlo alebo je napl√°novan√© na minulos≈•");
            }
        }

        function cancelAutoRelease() {
            if (autoReleaseTimeout) {
                clearTimeout(autoReleaseTimeout);
                autoReleaseTimeout = null;
                console.log("‚ùå Automatick√© uvoƒænenie zru≈°en√©");
            }
        }

        window.toggleAdmin = async function() {
            const pin = await window.promptPin("Admin PIN:");
            if (pin === globalSettings.masterPin) {
                document.getElementById('adminSection').style.display = 'block';
                renderAdminPinTable(); window.scrollTo(0, document.body.scrollHeight);
            } else { alert("Zl√Ω PIN"); }
        }

        window.saveQuizDate = async function() {
            const val = document.getElementById('adminQuizDate').value;
            if(val) {
                await updateDoc(doc(db, "config", "settings"), { quizDate: val });
                scheduleAutoCleanup();
                scheduleAutoRelease();
            }
        }
        window.stopRegistration = async function() {
            if(confirm("Zastavi≈• registr√°ciu?")) {
                await updateDoc(doc(db, "config", "settings"), { quizDate: null });
                document.getElementById('adminQuizDate').value = "";
                cancelAutoCleanup();
                cancelAutoRelease();
            }
        }
        window.saveMasterPin = async function() {
            const val = document.getElementById('newMasterPin').value;
            if(val.length > 2) { await updateDoc(doc(db, "config", "settings"), { masterPin: val }); alert("OK"); }
        }
        window.saveDeadlineTime = async function() {
            const timeValue = document.getElementById('adminDeadlineTime').value;
            if (!timeValue) {
                alert("‚ùå Zadaj ƒças!");
                return;
            }
            const [hour, minute] = timeValue.split(':').map(Number);
            if (isNaN(hour) || isNaN(minute) || hour < 0 || hour > 23 || minute < 0 || minute > 59) {
                alert("‚ùå Neplatn√Ω ƒças!");
                return;
            }
            try {
                await updateDoc(doc(db, "config", "settings"), { 
                    deadlineHour: hour, 
                    deadlineMinute: minute 
                });
                alert(`‚úÖ Deadline ƒças bol nastaven√Ω na ${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}!`);
                setTimeout(() => {
                    updateDashboard();
                }, 100);
            } catch (err) {
                console.error("Chyba pri ukladan√≠:", err);
                alert("‚ùå Chyba pri ukladan√≠: " + err.message);
            }
        }

        window.saveReleaseTime = async function() {
            const timeValue = document.getElementById('adminReleaseTime').value;
            if (!timeValue) {
                alert("‚ùå Zadaj ƒças!");
                return;
            }
            const [hour, minute] = timeValue.split(':').map(Number);
            if (isNaN(hour) || isNaN(minute) || hour < 0 || hour > 23 || minute < 0 || minute > 59) {
                alert("‚ùå Neplatn√Ω ƒças!");
                return;
            }
            try {
                const formattedTime = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                const newText = `‚è≥ Rezervovan√© (do ${formattedTime})`;
                
                // Aktualizuj aj ƒças v settings aj text v pageTexts
                await updateDoc(doc(db, "config", "settings"), { 
                    releaseHour: hour, 
                    releaseMinute: minute 
                });
                
                await updateDoc(doc(db, "config", "pageTexts"), {
                    "text-index.html-1": newText
                });
                
                alert(`‚úÖ ƒåas uvoƒænenia bol nastaven√Ω na ${formattedTime}!`);
                // Aktualizuj display textu vƒæavo
                const reservedDisplay = document.getElementById('reservedDeadlineDisplay');
                if (reservedDisplay) {
                    reservedDisplay.innerText = formattedTime;
                }
                scheduleAutoRelease();
            } catch (err) {
                console.error("Chyba pri ukladan√≠:", err);
                alert("‚ùå Chyba pri ukladan√≠: " + err.message);
            }
        }
        
        window.saveMaxCapacity = async function() {
            const capacityInput = document.getElementById('adminMaxCapacity');
            const val = parseInt(capacityInput.value);
            if (isNaN(val) || val < 1 || val > 999) {
                alert("‚ùå Kapacita mus√≠ by≈• ƒç√≠slo medzi 1 a 999!");
                return;
            }
            try {
                await updateDoc(doc(db, "config", "settings"), { maxCapacity: val });
                alert(`‚úÖ Celkov√° kapacita bola nastaven√° na ${val}!`);
            } catch (err) {
                console.error("Chyba pri ukladan√≠ kapacity:", err);
                alert("‚ùå Chyba pri ukladan√≠: " + err.message);
            }
        }

        window.uploadDefaults = async function() {
            if(!confirm("Nahra≈• 11 st√°lych t√≠mov do DB? (Len ak je pr√°zdna)")) return;
            const batch = writeBatch(db);
            defaultTeamsList.forEach(team => {
                const ref = doc(db, "teams", team.id);
                batch.set(ref, {
                    default: team.default, current: team.default, pin: team.pin, confirmed: false, isStatic: true, tableId: ""
                });
            });
            await batch.commit(); alert("T√≠my nahrat√©!");
        }

        window.renderAdminPinTable = function() {
            console.log('üî∂ renderAdminPinTable CALLED');
            const activeElement = document.activeElement;
            console.log('Active element:', activeElement);
            console.log('Active element tag:', activeElement ? activeElement.tagName : 'null');
            if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA') && 
                activeElement.closest('#adminConfirmedTableBody, #adminPinTableBody')) {
                console.log('üî∂ BLOCKED - active element is in admin table');
                return;
            }
            console.log('üî∂ Proceeding with render...');
            
            const confirmedTbody = document.getElementById('adminConfirmedTableBody');
            confirmedTbody.innerHTML = "";
            const confirmedTeams = teamsData.filter(t => t.confirmed);
            if (confirmedTeams.length === 0) {
                confirmedTbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999; padding:20px;">≈Ωiadne potvrden√© t√≠my</td></tr>';
            } else {
                confirmedTeams.forEach((t) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${t.id}</strong> ${!t.isStatic ? '<span style="color:#999; font-size:11px;">(Nov√Ω)</span>' : ''}</td>
                        <td><input type="number" class="admin-input w-small" id="confirmed_count_${t.id}" value="${t.current}" min="1" max="15" style="width:60px;"></td>
                        <td><span style="color:#27ae60; font-weight:bold;">‚úÖ Potvrden√Ω</span></td>
                        <td>
                            <button class="btn-save-pin" onclick="window.updateConfirmedTeam('${t.id}')" style="margin-right:10px;">üíæ Ulo≈æi≈•</button>
                            <button class="btn-delete-team" onclick="window.removeConfirmedTeam('${t.id}')">üóëÔ∏è Odstr√°ni≈•</button>
                        </td>`;
                    confirmedTbody.appendChild(tr);
                });
            }

            const tbody = document.getElementById('adminPinTableBody');
            tbody.innerHTML = "";
            teamsData.forEach((t) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${t.id} ${!t.isStatic ? '(Nov√Ω)' : ''} ${t.confirmed ? '<span style="color:#27ae60;">‚úì</span>' : ''}</td>
                    <td><input type="number" class="admin-input w-small" id="cap_${t.id}" value="${t.default}"></td>
                    <td><input type="text" class="admin-input w-med" id="pin_${t.id}" inputmode="numeric" pattern="[0-9]*" value="${t.pin}"></td>
                    <td><button class="btn-save-pin" onclick="window.saveAdminTeam('${t.id}')" style="margin-right:10px;">Ulo≈æi≈•</button>
                    <button class="btn-delete-team" onclick="window.deleteTeam('${t.id}')">Zmaza≈•</button></td>`;
                tbody.appendChild(tr);
            });
        }
        
        window.updateConfirmedTeam = async function(id) {
            const team = teamsData.find(t => t.id === id);
            if (!team) {
                alert("‚ùå T√≠m nebol n√°jden√Ω!");
                return;
            }
            const newCount = parseInt(document.getElementById(`confirmed_count_${id}`).value);
            if (isNaN(newCount) || newCount < 1 || newCount > 15) {
                alert("‚ùå Poƒçet hr√°ƒçov mus√≠ by≈• medzi 1 a 15!");
                return;
            }
            try {
                await updateDoc(doc(db, "teams", id), { current: newCount });
                alert(`‚úÖ Poƒçet hr√°ƒçov pre t√≠m "${id}" bol aktualizovan√Ω na ${newCount}!`);
            } catch (err) {
                console.error("Chyba pri aktualiz√°cii:", err);
                alert("‚ùå Chyba pri aktualiz√°cii: " + err.message);
            }
        }
        
        window.removeConfirmedTeam = async function(id) {
            const team = teamsData.find(t => t.id === id);
            if (!team) {
                alert("‚ùå T√≠m nebol n√°jden√Ω!");
                return;
            }
            
            if (team.isStatic) {
                if (!confirm(`‚ö†Ô∏è Vr√°ti≈• t√≠m "${id}" sp√§≈• medzi rezervovan√©?\n\nT√≠m m√° ${team.current} hr√°ƒçov a bol potvrden√Ω.\n\nPoƒçet sa zmen√≠ na predvolen√Ω (${team.default} os.).`)) {
                    return;
                }
                try {
                    await updateDoc(doc(db, "teams", id), { 
                        confirmed: false, 
                        current: team.default 
                    });
                    populateTeamSelect();
                    alert(`‚úÖ T√≠m "${id}" bol vr√°ten√Ω medzi rezervovan√©!`);
                } catch (err) {
                    console.error("Chyba pri aktualiz√°cii:", err);
                    alert("‚ùå Chyba pri vr√°ten√≠ t√≠mu: " + err.message);
                }
            } else {
                if (!confirm(`‚ö†Ô∏è Naozaj chce≈° odstr√°ni≈• t√≠m "${id}"?\n\nT√≠m m√° ${team.current} hr√°ƒçov a bol potvrden√Ω.\n\nT√°to akcia je nevratn√°!`)) {
                    return;
                }
                try {
                    await deleteDoc(doc(db, "teams", id));
                    populateTeamSelect();
                    alert(`‚úÖ T√≠m "${id}" bol √∫spe≈°ne odstr√°nen√Ω!`);
                } catch (err) {
                    console.error("Chyba pri mazan√≠:", err);
                    alert("‚ùå Chyba pri odstra≈àovan√≠ t√≠mu: " + err.message);
                }
            }
        }

        window.clearAllConfirmedTeams = async function() {
            const confirmedTeams = teamsData.filter(t => t.confirmed);
            
            if (confirmedTeams.length === 0) {
                alert("‚ÑπÔ∏è Nem√°≈° ≈æiadne potvrden√© t√≠my!");
                return;
            }
            
            const staticCount = confirmedTeams.filter(t => t.isStatic).length;
            const newCount = confirmedTeams.filter(t => !t.isStatic).length;
            
            let message = `‚ö†Ô∏è Naozaj chce≈° vymaza≈• v≈°etk√Ωch ${confirmedTeams.length} potvrden√Ωch t√≠mov?\n\n`;
            if (staticCount > 0) message += `‚Ä¢ ${staticCount} statick√Ωch t√≠mov sa vr√°tia medzi rezervovan√©\n`;
            if (newCount > 0) message += `‚Ä¢ ${newCount} nov√Ωch t√≠mov sa √∫plne odstr√°ni\n`;
            message += `\nT√°to akcia je ƒçiastoƒçne nevratn√°!`;
            
            if (!confirm(message)) {
                return;
            }
            
            try {
                const batch = writeBatch(db);
                
                confirmedTeams.forEach(team => {
                    if (team.isStatic) {
                        batch.update(doc(db, "teams", team.id), { 
                            confirmed: false, 
                            current: team.default 
                        });
                    } else {
                        batch.delete(doc(db, "teams", team.id));
                    }
                });
                
                await batch.commit();
                populateTeamSelect();
                alert(`‚úÖ V≈°etci potvrden√≠ hr√°ƒçi boli vymazan√≠!\n\n${staticCount} statick√Ωch t√≠mov je teraz medzi rezervovan√Ωmi.\n${newCount} nov√Ωch t√≠mov bolo odstr√°nen√Ωch.`);
                
            } catch (err) {
                console.error("Chyba pri vymazan√≠ v≈°etk√Ωch t√≠mov:", err);
                alert("‚ùå Chyba pri vymazan√≠: " + err.message);
            }
        }

        window.cancelTeamParticipation = async function() {
            const teamSelect = document.getElementById('teamSelect');
            const pinInput = document.getElementById('teamPin');
            const customTeamInput = document.getElementById('customTeamName');
            let teamId = teamSelect.value;
            let enteredPin = pinInput.value;
            
            if (teamId === 'new') {
                teamId = customTeamInput.value.trim();
            }
            
            if (!teamId) {
                alert("‚ùå Vyber si svoj t√≠m!");
                return;
            }
            
            if (!enteredPin || !enteredPin.trim()) {
                const promptedPin = await window.promptPin("‚ùì Zadaj PIN k√≥d:");
                if (!promptedPin) {
                    return;
                }
                enteredPin = promptedPin;
            }
            
            const team = teamsData.find(t => t.id === teamId);
            if (!team) {
                alert("‚ùå T√≠m nebol n√°jden√Ω!");
                return;
            }
            
            if (!team.confirmed) {
                alert("‚ùå T√≠m nie je potvrden√Ω!");
                return;
            }
            
            const enteredPinTrimmed = enteredPin.trim();
            const teamPinTrimmed = String(team.pin || "").trim();
            const masterPinTrimmed = String(globalSettings.masterPin || "").trim();
            
            if (enteredPinTrimmed !== teamPinTrimmed && enteredPinTrimmed !== masterPinTrimmed) {
                alert("‚ùå Nespr√°vny PIN! Zru≈°enie zlyhalo.");
                return;
            }
            
            const confirmMsg = team.isStatic 
                ? `‚ö†Ô∏è Chce≈° naozaj zru≈°i≈• √∫ƒças≈• t√≠mu "${teamId}"?\n\nT√≠m m√° ${team.current} hr√°ƒçov.\nBude≈° medzi rezervovan√Ωmi s poƒçtom ${team.default} os.\n\nD√° sa to kedykoƒævek opakova≈•.`
                : `‚ö†Ô∏è Chce≈° naozaj zru≈°i≈• √∫ƒças≈• t√≠mu "${teamId}"?\n\nT√≠m m√° ${team.current} hr√°ƒçov.\nT√°to akcia je nevratn√° - t√≠m sa √∫plne odstr√°ni!\n\nPotom sa bude≈° musie≈• znova zaregistrova≈•.`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            try {
                if (team.isStatic) {
                    await updateDoc(doc(db, "teams", teamId), { 
                        confirmed: false, 
                        current: team.default 
                    });
                    // √öspech - bez alert, confirm bolo dostaƒçuj√∫ce
                } else {
                    await deleteDoc(doc(db, "teams", teamId));
                    // √öspech - bez alert, confirm bolo dostaƒçuj√∫ce
                }
                
                document.getElementById('teamSelect').value = 'new';
                document.getElementById('teamPin').value = "";
                document.getElementById('customTeamName').value = "";
                document.getElementById('cancelBtn').style.display = 'none';
                
                // Zobraz success spr√°vu v existuj√∫com formMessage elemente
                const formMsg = document.getElementById('formMessage');
                if (formMsg) {
                    formMsg.innerText = `‚úÖ √öƒças≈• t√≠mu "${teamId}" bola zru≈°en√°!`;
                    formMsg.style.color = 'green';
                }
                
                window.handleTeamChange();
                
            } catch (err) {
                console.error("Chyba pri zru≈°en√≠ √∫ƒçasti:", err);
                alert("‚ùå Chyba pri zru≈°en√≠ √∫ƒçasti: " + err.message);
            }
        }
        
        window.declineTeamParticipation = async function() {
            const teamSelect = document.getElementById('teamSelect');
            const pinInput = document.getElementById('teamPin');
            let teamId = teamSelect.value;
            let enteredPin = pinInput.value;
            
            if (teamId === 'new') {
                alert("‚ùå Vyber si svoj t√≠m!");
                return;
            }
            
            const team = teamsData.find(t => t.id === teamId);
            if (!team) {
                alert("‚ùå T√≠m nebol n√°jden√Ω!");
                return;
            }
            
            if (!team.isStatic || team.confirmed) {
                alert("‚ùå Toto tlaƒçidlo je iba pre rezervovan√© t√≠my!");
                return;
            }
            
            if (!enteredPin || !enteredPin.trim()) {
                const promptedPin = await window.promptPin("‚ùì Zadaj PIN k√≥d:");
                if (!promptedPin) {
                    return;
                }
                enteredPin = promptedPin;
            }
            
            const enteredPinTrimmed = enteredPin.trim();
            const teamPinTrimmed = String(team.pin || "").trim();
            const masterPinTrimmed = String(globalSettings.masterPin || "").trim();
            
            if (enteredPinTrimmed !== teamPinTrimmed && enteredPinTrimmed !== masterPinTrimmed) {
                alert("‚ùå Nespr√°vny PIN! Akcia bola zru≈°en√°.");
                return;
            }
            
            const confirmMsg = `‚ö†Ô∏è Chce≈° odvola≈• √∫ƒças≈• t√≠mu "${teamId}"?\n\nT√Ωm sa uvoƒæn√≠ ${team.default} miest pre in√© t√≠my.\n\nP√¥vodn√Ω poƒçet miest ostane zachovan√Ω - m√¥≈æe≈° sa kedykoƒævek zaregistrova≈• sp√§≈•.`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            try {
                await updateDoc(doc(db, "teams", teamId), { 
                    current: 0,
                    declined: true
                });
                alert(`‚úÖ Miesta t√≠mu "${teamId}" bola √∫spe≈°ne uvoƒænen√°!\n\n${team.default} miest je teraz dostupn√Ωch pre in√© t√≠my.`);
                
                document.getElementById('teamSelect').value = 'new';
                document.getElementById('teamPin').value = "";
                document.getElementById('customTeamName').value = "";
                document.getElementById('declineBtn').style.display = 'none';
                setTimeout(() => { updateDashboard(); populateTeamSelect(); handleTeamChange(); }, 100);
                
            } catch (err) {
                console.error("Chyba pri odvolan√≠ √∫ƒçasti:", err);
                alert("‚ùå Chyba pri odvolan√≠ √∫ƒçasti: " + err.message);
            }
        }
        
        window.populateCancelTeamSelect = function() {
        }
        window.saveAdminTeam = async function(id) {
            const cap = parseInt(document.getElementById(`cap_${id}`).value);
            const pin = String(document.getElementById(`pin_${id}`).value.trim());
            const t = teamsData.find(x => x.id === id);
            let updates = { default: cap, pin: pin, declined: false };
            if (!t.confirmed) updates.current = cap;
            await updateDoc(doc(db, "teams", id), updates); alert("Ulo≈æen√©");
        }
        
        window.saveAllAdminTeams = async function() {
            const batch = writeBatch(db);
            let successCount = 0;
            let errorCount = 0;
            
            teamsData.forEach((t) => {
                const capInput = document.getElementById(`cap_${t.id}`);
                const pinInput = document.getElementById(`pin_${t.id}`);
                
                if (capInput && pinInput) {
                    const cap = parseInt(capInput.value);
                    const pin = String(pinInput.value.trim());
                    
                    if (!isNaN(cap) && cap > 0) {
                        let updates = { default: cap, pin: pin, declined: false };
                        if (!t.confirmed) updates.current = cap;
                        
                        const ref = doc(db, "teams", t.id);
                        batch.update(ref, updates);
                        successCount++;
                    } else {
                        errorCount++;
                    }
                }
            });
            
            try {
                await batch.commit();
                alert(`‚úÖ V≈°etky t√≠my boli √∫spe≈°ne ulo≈æen√©!\n\nAktualizovan√Ωch: ${successCount}\nCh√Ωb: ${errorCount}`);
                updateDashboard();
                renderAdminPinTable();
            } catch (err) {
                console.error("Chyba pri hromadnom ulo≈æen√≠:", err);
                alert("‚ùå Chyba pri ulo≈æen√≠: " + err.message);
            }
        }
        window.deleteTeam = async function(id) { 
            if(confirm("Zmaza≈• " + id + "?")) {
                await deleteDoc(doc(db, "teams", id));
                populateTeamSelect();
            }
        }
        window.addNewTeam = async function() {
            const name = document.getElementById('addTeamName').value.trim();
            const cap = parseInt(document.getElementById('addTeamCap').value);
            const pin = String(document.getElementById('addTeamPin').value.trim());
            if(name && cap && pin) {
                await setDoc(doc(db, "teams", name), { default: cap, current: cap, pin: pin, confirmed: false, isStatic: true, tableId: "" });
                document.getElementById('addTeamName').value = "";
                document.getElementById('addTeamCap').value = "4";
                document.getElementById('addTeamPin').value = "000";
            }
        }
        window.resetAllData = async function() {
            if(!confirm("‚ö†Ô∏è FULL WIPE?")) return;
            const batch = writeBatch(db);
            teamsData.forEach(t => {
                const ref = doc(db, "teams", t.id);
                if (!t.isStatic) batch.delete(ref);
                else batch.update(ref, { current: t.default, confirmed: false });
            });
            await batch.commit(); alert("Reset hotov√Ω.");
        }
        
        // Table assignments storage
        let tableAssignments = {}; // { tableNum: teamId }
        
        // Load table assignments from Firebase
        async function loadTableAssignments() {
            try {
                const assignDoc = await getDoc(doc(db, "config", "table_assignments"));
                if (assignDoc.exists()) {
                    tableAssignments = assignDoc.data().assignments || {};
                    updateMapVisuals();
                }
            } catch (err) {
                console.error("Chyba pri naƒç√≠tan√≠ priraden√≠ stolov:", err);
            }
        }
        
        // Save table assignments to Firebase
        async function saveTableAssignments() {
            try {
                await setDoc(doc(db, "config", "table_assignments"), {
                    assignments: tableAssignments
                });
                console.log("‚úÖ Priradenia stolov ulo≈æen√©");
            } catch (err) {
                console.error("‚ùå Chyba pri ukladan√≠ priraden√≠:", err);
                alert("Chyba pri ukladan√≠: " + err.message);
            }
        }
        
        // Open modal to assign team to table
        window.adminEdit = function(el) {
            if (!window.adminLoggedIn && !(window.auth && window.auth.currentUser)) {
                alert("Mapu upravuje≈° cez zoznam t√≠mov ni≈æ≈°ie.");
                return;
            }
            
            const tableNum = el.getAttribute('data-table-num');
            if (!tableNum) return;
            
            const modal = document.getElementById('tableAssignModal');
            const overlay = document.getElementById('tableAssignOverlay');
            const title = document.getElementById('modalTableTitle');
            const teamList = document.getElementById('modalTeamList');
            
            title.innerText = `St√¥l ${tableNum}`;
            modal.setAttribute('data-current-table', tableNum);
            
            // Build team list
            teamList.innerHTML = '';
            
            // Sort teams: confirmed first, then reserved, then by name
            const sortedTeams = [...teamsData].sort((a, b) => {
                if (a.confirmed && !b.confirmed) return -1;
                if (!a.confirmed && b.confirmed) return 1;
                return a.id.localeCompare(b.id);
            });
            
            sortedTeams.forEach(team => {
                const option = document.createElement('div');
                option.className = 'team-option';
                if (team.confirmed) option.classList.add('confirmed');
                else if (team.isStatic) option.classList.add('reserved');
                
                const namePart = document.createElement('span');
                namePart.className = 'team-name';
                namePart.innerText = team.id;
                
                const countPart = document.createElement('span');
                countPart.className = 'team-count';
                const status = team.confirmed ? '‚úÖ' : (team.isStatic ? '‚è≥' : '');
                countPart.innerText = `${status} ${team.current} os.`;
                
                option.appendChild(namePart);
                option.appendChild(countPart);
                
                option.onclick = function() {
                    assignTeamToTable(tableNum, team.id);
                    closeTableAssignModal();
                };
                
                teamList.appendChild(option);
            });
            
            modal.style.display = 'block';
            overlay.style.display = 'block';
        };
        
        window.closeTableAssignModal = function() {
            const modal = document.getElementById('tableAssignModal');
            const overlay = document.getElementById('tableAssignOverlay');
            modal.style.display = 'none';
            overlay.style.display = 'none';
        };
        
        function assignTeamToTable(tableNum, teamId) {
            tableAssignments[tableNum] = teamId;
            saveTableAssignments();
            updateMapVisuals();
        }
        
        window.clearTableAssignment = function() {
            const modal = document.getElementById('tableAssignModal');
            const tableNum = modal.getAttribute('data-current-table');
            if (tableNum && tableAssignments[tableNum]) {
                delete tableAssignments[tableNum];
                saveTableAssignments();
                updateMapVisuals();
                window.closeTableAssignModal();
            }
        };
        
        window.clearAllTableAssignments = function() {
            if (confirm('‚ö†Ô∏è Naozaj chcete vyƒçisti≈• v≈°etky stoly? V≈°etky priradenia bud√∫ odstr√°nen√©.')) {
                tableAssignments = {};
                saveTableAssignments();
                updateMapVisuals();
                alert('‚úÖ V≈°etky stoly boli vyƒçisten√©.');
            }
        };
        
        function updateMapVisuals() {
            // Update all table displays based on assignments
            for (let i = 1; i <= 14; i++) {
                const tableEl = document.querySelector(`[data-table-num="${i}"]`);
                if (!tableEl) continue;
                
                const teamId = tableAssignments[i];
                const tableNumber = tableEl.querySelector('.table-number');
                
                if (teamId) {
                    const team = teamsData.find(t => t.id === teamId);
                    if (team) {
                        // Update table text to show assigned team
                        tableEl.innerHTML = '';
                        if (tableNumber) tableEl.appendChild(tableNumber);
                        tableEl.appendChild(document.createTextNode(team.id));
                        
                        const newCapInfo = document.createElement('div');
                        newCapInfo.className = 'cap-info';
                        newCapInfo.innerText = `${team.current} os.`;
                        tableEl.appendChild(newCapInfo);
                        
                        // Update status class
                        tableEl.classList.remove('status-free', 'status-reserved', 'status-confirmed');
                        if (team.confirmed) {
                            tableEl.classList.add('status-confirmed');
                        } else if (team.isStatic) {
                            tableEl.classList.add('status-reserved');
                        } else {
                            tableEl.classList.add('status-free');
                        }
                    }
                } else {
                    // No team assigned - reset to "Voƒæn√Ω"
                    tableEl.innerHTML = '';
                    if (tableNumber) tableEl.appendChild(tableNumber);
                    tableEl.appendChild(document.createTextNode('Voƒæn√Ω'));
                    
                    const newCapInfo = document.createElement('div');
                    newCapInfo.className = 'cap-info';
                    newCapInfo.innerText = '0 os.';
                    tableEl.appendChild(newCapInfo);
                    
                    // Set as free
                    tableEl.classList.remove('status-reserved', 'status-confirmed');
                    tableEl.classList.add('status-free');
                }
            }
        }

        function loadWebContentToEditor(page) {
            const contentDoc = doc(db, "web_content", page);
            getDoc(contentDoc).then((docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    Object.keys(data).forEach(key => {
                        const inputId = `edit_${key}`;
                        const input = document.getElementById(inputId);
                        if (input) {
                            input.value = data[key];
                        }
                    });
                } else {
                    initializeDefaultContent(page);
                }
            });
        }

        function initializeDefaultContent(page) {
            const defaults = {
                home: {
                    home_hero_title: "Najbli≈æ≈°√≠ kv√≠z - 7. febru√°r",
                    home_hero_description: "Pre √∫ƒças≈• je potrebn√© si rezervova≈• st√¥l a ma≈• nain≈°talovan√∫ najnov≈°iu aktualiz√°ciu na≈°ej aplik√°cie.",
                    home_btn_reserve: "Rezervova≈• st√¥l",
                    home_btn_download: "Stiahnu≈• Appku",
                    home_fact1_title: "üìÖ Ako ƒçasto je kv√≠z ?",
                    home_fact1_text: "Ka≈æd√© dva t√Ω≈ædne v piatok alebo v sobotu Lukia's Lounge & More, ≈†af√°rikova 8 v Ro≈æ≈àave",
                    home_quiz_topic_title: "T√©ma najbli≈æ≈°ieho kv√≠zu ?",
                    home_quiz_topic_text: "Zatiaƒæ nevieme alebo sme neaktualizovaliüòÇ",
                    home_quiz_topic_link: "üìò Hlasuj na Facebooku",
                    home_fact2_title: "üßÄ Vedeli ste ≈æe..?",
                    home_fact2_text: "Najviac kradnut√° potravina na svete je SYR."
                },
                about: {
                    about_who_title: "Kto sme?",
                    about_who_text: "Sme bratia Branƒçi a Marcel a kv√≠zy s√∫ na≈°ou srdcovkou u≈æ od roku 2018. To, ƒço zaƒçalo ako voƒænoƒçasov√Ω projekt v bare Font√°na s kamo≈°om Jarom Strelkom, prer√°stlo do komunity, ktor√° sa u≈æ roky pravidelne stret√°va pri vedomostn√Ωch s√∫bojoch.",
                    about_why_title: "Preƒço pr√≠s≈• na n√°≈° kv√≠z?",
                    about_why_subtitle1: "Z√°bava pri jednom stole",
                    about_why_text1: "Na≈°e ot√°zky s√∫ v≈°eobecn√© a f√©rov√©. Nechceme, aby ste sypali z ruk√°va letopoƒçty, ale aby ste sa v t√≠me poradili, zapojili logiku a spoloƒçne pri≈°li na odpoveƒè. Ten pocit, keƒè nieƒço tu≈°√≠te a nakoniec je to spr√°vne, je na nezaplatenie.",
                    about_why_subtitle2: "Dobr√° n√°lada aj s√∫≈•a≈æivos≈•",
                    about_why_text2: "V Lukia's Lounge & More to ka≈æd√© dva t√Ω≈ædne ≈æije. Je to priateƒæsk√©, uvoƒænen√©, ale keƒè ide do tuh√©ho a na stole s√∫ fƒæa≈°e kvalitn√©ho alkoholu pre v√≠≈•azov, atmosf√©ra vie poriadne zhustn√∫≈•!",
                    about_why_subtitle3: "Ideme s dobou",
                    about_why_text3: "Nie sme len moder√°tori s papiermi. Sme technick√≠ nad≈°enci a pre na≈°e kv√≠zy sme vyvinuli vlastn√∫ aplik√°ciu (dostupn√∫ na Google Play), ktor√° pos√∫va z√°≈æitok z hry na √∫plne in√∫ √∫rove≈à.",
                    about_journey_title: "Na≈°a cesta v skratke",
                    about_journey_text1: "<strong>2018 ‚Äì 2020:</strong> ≈†tartovacia ƒçiara v bare Font√°na.",
                    about_journey_text2: "<strong>2020 ‚Äì 2023:</strong> Presun do ≈†ug√°ru a kv√≠zovanie cez n√°roƒçn√© obdobia.",
                    about_journey_text3: "<strong>2024 ‚Äì s√∫ƒçasnos≈•:</strong> Na≈°a nov√° z√°klad≈àa v Lukia's Lounge & More.",
                    about_final_text: "Pr√≠ƒète si vyvetra≈• hlavu, nieƒço nov√© sa nauƒçi≈• a uk√°za≈•, ≈æe v√°≈° t√≠m na to m√°. Vid√≠me sa pri ƒèal≈°om kole!"
                },
                app: {
                    app_main_title: "Na≈°a aplik√°cia",
                    app_qr_text: "Naskenujte QR k√≥d",
                    app_download_title: "Stiahnu≈• aplik√°ciu",
                    app_download_description: "Aplik√°cia je dostupn√° na Google Play",
                    app_download_btn: "üì± Stiahnu≈• z Google Play",
                    app_why_title: "Preƒço vlastn√° aplik√°cia?",
                    app_why_text: "Keƒè≈æe ≈æiadna z dostupn√Ωch aplik√°ci√≠ na trhu nedok√°zala spravi≈• to, ƒço sme potrebovali, tak sme si spravili vlastn√∫. Kv√≠zy teda funguj√∫ √∫plne rovnako ako fungovali bez nej, av≈°ak je to oveƒæa efekt√≠vnej≈°ie. V aplik√°cii je zabudovan√° aj detekcia podv√°dzania, tak≈æe to ani nesk√∫≈°ajte lebo pr√≠dete o body üòÇ. Cez aplik√°ciu v√°m tie≈æ budeme posiela≈• d√¥le≈æit√© ozn√°menia ako napr. d√°tum ƒèal≈°ieho kv√≠zu.",
                    app_how_title: "Ako funguje aplik√°cia?",
                    app_feature1_title: "üì≤ Hlasovanie mobilom",
                    app_feature1_text: "≈Ωiadne papiere. Odpovede posiela≈° priamo cez appku.",
                    app_feature2_title: "‚ö° Okam≈æit√© vyhodnotenie",
                    app_feature2_text: "Aplik√°cia dok√°≈æe zobrazi≈• r√¥zne typy ot√°zok a tvoju odpoveƒè n√°≈° syst√©m vyhodnot√≠ okam≈æite.",
                    app_feature3_title: "üõ°Ô∏è Ochrana proti podv√°dzaniu",
                    app_feature3_text: "Zabudovan√° detekcia podv√°dzania zabezpeƒçuje f√©rov√∫ hru pre v≈°etk√Ωch.",
                    app_feature4_title: "üîî D√¥le≈æit√© ozn√°menia",
                    app_feature4_text: "Dost√°vajte upozornenia na d√°tum ƒèal≈°ieho kv√≠zu a ƒèal≈°ie d√¥le≈æit√© inform√°cie.",
                    app_steps_title: "Ako postupova≈•?",
                    app_step1: "<strong>Stiahnite si aplik√°ciu</strong> - pou≈æite QR k√≥d vy≈°≈°ie alebo odkaz na Google Play",
                    app_step2: "<strong>Nain≈°talujte</strong> aplik√°ciu na svoj Android telef√≥n",
                    app_step3: "<strong>Vypnite d√°ta a pripojte sa v bare na na≈°u lok√°lnu sie≈• QuizBrothers</strong>",
                    app_step4: "<strong>Zadajte n√°zov svojho t√≠mu alebo kliknite na tlaƒçidlo \"Vybra≈• t√≠m\"</strong> - n√°jdite svoj t√≠m v zozname a pripojte sa",
                    app_step5: "<strong>HOTOVO</strong> - m√¥≈æete zaƒça≈• hra≈•! üéâ"
                }
            };

            if (defaults[page]) {
                Object.keys(defaults[page]).forEach(key => {
                    const inputId = `edit_${key}`;
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.value = defaults[page][key];
                    }
                });
            }
        }

        window.saveWebContent = async function(page) {
            const contentDoc = doc(db, "web_content", page);
            const updateData = {};
            const prefix = page === 'home' ? 'home' : page === 'about' ? 'about' : 'app';
            
            const allInputs = document.querySelectorAll('[id^="edit_"]');
            allInputs.forEach(input => {
                const key = input.id.replace('edit_', '');
                if (key.startsWith(prefix + '_')) {
                    updateData[key] = input.value;
                }
            });

            try {
                await setDoc(contentDoc, updateData, { merge: true });
                alert(`‚úÖ Obsah pre ${page === 'home' ? 'Domov' : page === 'about' ? 'O n√°s' : 'Aplik√°cia'} bol ulo≈æen√Ω!`);
            } catch (err) {
                console.error("Chyba pri ukladan√≠:", err);
                alert("‚ùå Chyba pri ukladan√≠: " + err.message);
            }
        }

        function updateAdminUIVisibility() {
            const isAdmin = window.qbAdmin && window.qbAdmin.isUserAdmin();
            const isAdminLoggedIn = window.adminLoggedIn === true;
            const adminAuth = window.auth && window.auth.currentUser;
            
            const finalIsAdmin = isAdmin || isAdminLoggedIn || (adminAuth ? true : false);
            
            const adminSection = document.getElementById('adminSection');
            const pinSection = document.getElementById('pinSection');
            const adminLoginPrompt = document.getElementById('adminLoginPrompt');
            const oldAdminBtn = document.getElementById('adminOldLoginBtn');
            
            if (finalIsAdmin) {
                adminSection.style.display = 'block';
                pinSection.style.display = 'none';
                adminLoginPrompt.style.display = 'none';
                if (oldAdminBtn) oldAdminBtn.style.display = 'none';
                
                loadWebContentToEditor('home');
                loadWebContentToEditor('about');
                loadWebContentToEditor('app');
                renderAdminPinTable();
                loadTableAssignments();
            } else {
                adminSection.style.display = 'none';
                pinSection.style.display = 'block';
                adminLoginPrompt.style.display = 'block';
                if (oldAdminBtn) oldAdminBtn.style.display = 'block';
            }
        }
        
        const originalToggleAdmin = window.toggleAdmin;
        window.toggleAdmin = async function() {
            const pin = await window.promptPin("Admin PIN:");
            if (pin === globalSettings.masterPin) {
                document.getElementById('adminSection').style.display = 'block';
                renderAdminPinTable();
                loadWebContentToEditor('home');
                loadWebContentToEditor('about');
                loadWebContentToEditor('app');
                await loadTableAssignments();
                updateMapVisuals();
                window.scrollTo(0, document.body.scrollHeight);
            } else {
                alert("Zl√Ω PIN");
            }
        }
        
        setInterval(function() {
            updateAdminUIVisibility();
        }, 1000);
    </script>
    </div>

    <footer>
        <img src="../logo.png" alt="QuizBrothers Logo" class="footer-logo">
        <div>&copy; 2026 QuizBrothers. V≈°etky pr√°va vyhraden√©.</div>
    </footer>

    <!-- Admin Button Initialization -->
    <script>
        (function() {
            function createAdminButton() {
                if (document.getElementById('admin-activate-btn')) return;
                const btn = document.createElement('button');
                btn.id = 'admin-activate-btn';
                btn.innerHTML = '‚öô';
                btn.title = 'Admin m√≥d';
                btn.style.cssText = `
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    opacity: 0.5;
                    transition: opacity 0.3s;
                    padding: 10px;
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    z-index: 9999;
                `;
                btn.onmouseover = function() { this.style.opacity = '1'; };
                btn.onmouseout = function() { this.style.opacity = '0.5'; };
                btn.onclick = function() {
                    if (window.qbAdmin && window.qbAdmin.showLoginModal) {
                        window.qbAdmin.showLoginModal();
                    }
                };
                document.body.appendChild(btn);
            }
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', createAdminButton);
            } else {
                createAdminButton();
            }
        })();
    </script>

    <script src="../admin.js"></script>
    
    <!-- Custom PIN Modal Dialog - ISOLATED AT END -->
    <div id="pinModalOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9998; pointer-events:auto;" data-no-admin-edit="true"></div>
    <div id="pinModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:15px; z-index:9999; box-shadow:0 0 50px rgba(0,0,0,0.5); width:90%; max-width:320px; pointer-events:auto; contain:layout style paint;" data-no-admin-edit="true">
        <h3 style="margin-top:0; margin-bottom:15px; color:#222454; font-size:18px;">üîí Zadaj PIN k√≥d</h3>
        <p style="color:#555; margin:0 0 20px 0; font-size:13px;">Pre potvrdenie zadaj PIN.</p>
        <input type="text" id="pinModalInput" inputmode="numeric" pattern="[0-9]*" placeholder="Napr. 1234" style="width:100%; padding:10px; border:2px solid #222454; border-radius:8px; font-size:16px; box-sizing:border-box; margin-bottom:20px; text-align:center; letter-spacing:2px;">
        <div style="display:flex; gap:10px;">
            <button onclick="window.confirmPin()" style="flex:1; background:#222454; color:white; border:none; padding:10px; border-radius:8px; font-weight:bold; cursor:pointer; font-size:14px;">‚úì OK</button>
            <button onclick="window.cancelPin()" style="flex:1; background:#ccc; color:#333; border:none; padding:10px; border-radius:8px; font-weight:bold; cursor:pointer; font-size:14px;">‚úó Zru≈°i≈•</button>
        </div>
    </div>

    <!-- Table Assignment Modal -->
    <div id="tableAssignOverlay" class="table-assign-modal-overlay" onclick="closeTableAssignModal()"></div>
    <div id="tableAssignModal" class="table-assign-modal">
        <h3 id="modalTableTitle">St√¥l</h3>
        <p style="text-align:center; color:#666; margin-bottom:15px; font-size:13px;">Vyberte t√≠m pre priradenie k stolu:</p>
        <div id="modalTeamList" style="max-height: 400px; overflow-y: auto;"></div>
        <button class="btn-clear" onclick="clearTableAssignment()">üóëÔ∏è Zru≈°i≈• priradenie</button>
        <button class="btn-close" onclick="closeTableAssignModal()">Zavrie≈•</button>
    </div>
</body>
</html>

